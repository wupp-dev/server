import{_ as a,o as e,c as i,ak as n,ay as o,az as l}from"./chunks/framework.Bs5efBfO.js";const g=JSON.parse('{"title":"Instalación del SO encriptado","description":"","frontmatter":{"order":3},"headers":[],"relativePath":"equipo/sistema-encriptado.md","filePath":"equipo/sistema-encriptado.md","lastUpdated":1769273126000}'),t={name:"equipo/sistema-encriptado.md"};function r(d,s,p,c,h,k){return e(),i("div",null,[...s[0]||(s[0]=[n('<h1 id="instalacion-del-so-encriptado" tabindex="-1">Instalación del SO encriptado <a class="header-anchor" href="#instalacion-del-so-encriptado" aria-label="Permalink to “Instalación del SO encriptado”">​</a></h1><p>Vamos a darle vida al cacharro ese que se hace llamar servidor. En esta sección instalaremos el sistema operativo con los discos encriptados y haremos un poco de configuración básica.</p><h2 id="escogiendo-y-descargando-el-sistema-operativo" tabindex="-1">Escogiendo y descargando el sistema operativo. <a class="header-anchor" href="#escogiendo-y-descargando-el-sistema-operativo" aria-label="Permalink to “Escogiendo y descargando el sistema operativo.”">​</a></h2><div class="info custom-block"><p class="custom-block-title custom-block-title-default">INFO</p><p>Para esta parte necesitarás:</p><ul><li>Un ordenador con Internet.</li><li>Un pendrive de unos <strong>4GB</strong> vacío o con archivos que no te importe perder.</li><li>Una pantalla y teclado extra para el servidor.</li></ul></div><p>Hay varias opciones para escoger como sistema operativo:</p><ul><li><a href="https://www.debian.org/" target="_blank" rel="noreferrer">Debian</a>.</li><li><a href="https://www.raspberrypi.com/software/operating-systems/" target="_blank" rel="noreferrer">Raspberry Pi OS</a> <em>(para Raspberry)</em>.</li><li><a href="https://ubuntu.com/download/server" target="_blank" rel="noreferrer">Ubuntu Server</a>.</li><li><a href="https://getfedora.org/en/server/" target="_blank" rel="noreferrer">Fedora Server</a>.</li></ul><p>Esos son solo algunos ejemplos, pero hay muchas opciones. En nuestro caso, el servidor tuvo instalado al principio Ubuntu Server, pero Lucas se puso tonto, así que hubo que cambiarlo a <strong>Debian</strong>, que según él es mejor <em>(<strong>Spoiler:</strong> No ha probado Ubuntu Server)</em>.</p><h3 id="descarga-y-preparacion-del-instalador-de-debian" tabindex="-1">Descarga y preparación del instalador de Debian <a class="header-anchor" href="#descarga-y-preparacion-del-instalador-de-debian" aria-label="Permalink to “Descarga y preparación del instalador de Debian”">​</a></h3><p>Actualmente la versión de Debian del servidor es la 13, también llamada Trixie. La forma más sencilla de instalarlo es descargar la ISO del principio de su <a href="https://www.debian.org/download" target="_blank" rel="noreferrer">página de descarga</a>, ya que es un instalador muy ligero.</p><div class="warning custom-block"><p class="custom-block-title">ADVERTENCIA</p><p>Esa ISO de Debian necesita que el servidor se pueda conectar a Internet en el momento de la instalación, así que ten preparado el cable para conectarlo.</p></div><p>Una vez descargada la ISO, tenemos que grabarla en el pendrive cosa que se puede hacer con <a href="https://www.balena.io/etcher/" target="_blank" rel="noreferrer">Balena Etcher</a>.</p><p>Ese pendrive lo cogemos y lo enchufamos al servidor.</p><h2 id="configuracion-de-la-uefi-del-servidor" tabindex="-1">Configuración de la UEFI del servidor <a class="header-anchor" href="#configuracion-de-la-uefi-del-servidor" aria-label="Permalink to “Configuración de la UEFI del servidor”">​</a></h2><p>Antes de instalar el sistema operativo, tenemos que hacer unos retoques en la UEFI (también conocida como la BIOS), así que enciende el servidor y accede a la UEFI <em>(si no sabes cómo, búscalo, porque cambia mucho de un ordenador a otro)</em>.</p><p>Aquí hay <strong>dos cambios muy importantes</strong> que hacer:</p><ul><li><strong>Activar</strong>, si estuviera desactivado, el <strong>Secure Boot</strong>, ya que nos aportará un extra de seguridad.</li><li>Establecer una <strong>contraseña de administrador</strong> de la UEFI.</li></ul><div class="info custom-block"><p class="custom-block-title custom-block-title-default">INFO</p><p>Puede que te encuentres con dos posibles contraseñas, la de <strong>usuario</strong> y la de <strong>administrador</strong>. La de usuario, si la creas, probablemente te la pida cada vez que el ordenador se encienda, cosa que no te conviene. La de administrador es la que nos interesa, que es la que se pide cuando se intenta acceder a la UEFI.</p></div><p>Una opción que nos puede interesar es la llamada <code>Restore on AC/Power loss</code>, que podremos encontrar por el apartado Boot o en avanzado. Podemos dejarla en <code>Last State</code> o <code>Memory</code> dependiendo de como salga, pero lo que viene a significar es que si se fuese la luz estando el ordenador encendido y luego volviese, el ordenador se encendería de nuevo. Esto es interesante por si hay un apagón y quieres que el servidor vuelva a estar encendido en cuanto vuelva la luz.</p><p>Salimos guardando los cambios y el ordenador debería reiniciarse y mostrar el instalador del sistema. Es posible que haya que seleccionar el pendrive como dispositivo de arranque manualmente, para ello habrá que pulsar una tecla concreta al encender el ordenador, como F12 o Esc, dependiendo del modelo.</p><h2 id="instalacion-de-debian" tabindex="-1">Instalación de Debian <a class="header-anchor" href="#instalacion-de-debian" aria-label="Permalink to “Instalación de Debian”">​</a></h2><p>Así se verá nuestro instalador <em>(si no lo han cambiado en las versiones posteriores)</em>:</p><p><img src="'+o+'" alt="Instalador"></p><p>La instalación gráfica y la otra son prácticamente iguales, la diferencia es que en la gráfica puedes usar el ratón.</p><p>Primero tocará elegir el idioma y la distribución del teclado <em>(nosotros elegimos Español para mayor comodidad, aunque después cambiamos a Inglés)</em>. Después se intentará conectar a Internet y tocará poner unos cuantos datos:</p><ol><li>El nombre de la máquina, como puede ser <code>server</code></li><li>El nombre del dominio, que para nuestro servidor es <code>wupp.dev</code> <em>(si no tienes el dominio o no sabes qué es, puedes hacerte spolier mirando la sección de <a href="./router-dominio.html#dominio-¿que-es-y-para-que-sirve">Router y dominio</a>)</em>.</li><li>La contraseña para el usuario <code>root</code>. Esta contraseña tiene que ser <strong>potente</strong>, como de 20 caracteres, porque es la que permite hacer cualquier cambio en el sistema operativo.</li></ol><div class="tip custom-block"><p class="custom-block-title">TRUQUITO</p><p>Puedes generar, guardar y gestionar contraseñas cómodamente con <a href="https://bitwarden.com/" target="_blank" rel="noreferrer">Bitwarden</a>.</p></div><ol start="4"><li>El nombre del usuario administrativo, por ejemplo, <code>admin</code> <em>(tanto para el nombre completo como para el nombre de usuario)</em>.</li></ol><div class="warning custom-block"><p class="custom-block-title">ADVERTENCIA</p><p>El usuario escogido en la guía es <code>admin</code>. Este nombre es de ejemplo y Debian no te dejará usarlo.</p></div><ol start="5"><li>La contraseña para el usuario <code>admin</code>. Una contraseña que sea buena, especialmente si vas a usar <code>sudo</code>, ya que sería equivalente a tener la contraseña de <code>root</code>.</li><li>Configuración del reloj, de chill.</li></ol><p>Después de esto toca encriptar el disco de instalación.</p><h3 id="encriptacion-del-disco" tabindex="-1">Encriptación del disco <a class="header-anchor" href="#encriptacion-del-disco" aria-label="Permalink to “Encriptación del disco”">​</a></h3><p>Para no complicarnos la vida, aquí dejaremos que Debian haga la magia de gestionar las particiones porque si no nos tocaría sufrir mucho.</p><p>En el instalador, elegiremos el método de particionado <strong>Guiado - utilizar todo el disco y configurar LVM cifrado</strong>. Elegimos el disco donde queremos instalar el sistema operativo, que en nuestro caso es el SSD de 480GB y utilizamos como esquema de particionado <strong>Todos los ficheros en una partición (recomendado para novatos)</strong>.</p><p>Si, como en nuestro caso, disponemos de un disco duro mecánico de gran tamaño, puede ser interesante utilizarlo para montar la partición <code>/var</code>, que es donde se almacenan los logs, archivos temporales del sistema y donde guardaremos los datos de nuestros servicios, que pueden llegar a ser bastante grandes. Lo único a tener en cuenta es que docker también almacena las imágenes en <code>/var/lib/docker</code>, por lo que si se van a usar contenedores docker, es recomendable mover esa carpeta al SSD, ya que notaremos un gran cambio en el rendimiento de los contenedores. Nosotros hicimos el cambio a posteriori, estando documentado en <a href="./../relatos/moviendo-var.html">Moviendo /var a otro disco</a>.</p><p>Ahora, si aprecias tu tiempo y no tenías archivos altamente sensibles en el disco donde vas a instalar Debian, puedes elegir no borrar el disco, ya que tardaría un buen rato.</p><p>Tras eso, nos pedirá una <strong>contraseña de cifrado</strong> y esta sí que tiene que ser una tremenda contraseña. Mejor que la de los usuarios.</p><p>Ahora toca lo interesante. Le decimos que use todo el disco para el particionado y nos aparecerá una lista con las particiones que se van a crear.</p><p><img src="'+l+`" alt="Particiones"></p><p>Las particiones más importantes son:</p><ul><li>Una partición donde irá <strong>el sistema operativo y todos los datos</strong>. Por defecto aparecerá con el sistema de archivos <code>ext4</code>, uno de los más comunes en Linux.</li><li>Una partición de <strong>intercambio <em>(SWAP)</em></strong>, que se utiliza como una ampliación de la RAM.</li><li>Una partición <code>boot</code> que contiene los archivos necesarios para que el sistema operativo arranque.</li></ul><p>Se puede dejar tal y como está, pero nosotros hemos optado por usar <code>btrfs</code> en vez de <code>ext4</code> como sistema de archivos de la partición principal. Esto es por las grandes facilidades que da <code>btrfs</code> para hacer copias de seguridad del sistema al completo sin que ocupen casi espacio (snapshots).</p><p>Por suerte, cambiar el sistema de archivos es relativamente fácil, solo hay que ir a la línea donde aparece la palabra <code>ext4</code>, pulsar &lt;Intro&gt; y en <strong>Utilizar como</strong> elegir el sistema <code>btrfs</code>. Salimos y ahora debería aparecer <code>btrfs</code> en vez de <code>ext4</code> como sistema de archivos. Finalizamos el particionado confirmando que se hagan los cambios elegidos y empezará la instalación del sistema operativo.</p><h3 id="terminando-la-instalacion" tabindex="-1">Terminando la instalación <a class="header-anchor" href="#terminando-la-instalacion" aria-label="Permalink to “Terminando la instalación”">​</a></h3><p>Una vez acabe la instalación, nos tocará configurar el gestor de paquetes, elegir una ubicación y un proxy si hace falta, pero se puede dejar todo por defecto y el proxy en blanco.</p><p>Ahora nos dejará elegir unos cuantos paquetes extra que instalar, estos son los cambios que hay que hacer:</p><div class="warning custom-block"><p class="custom-block-title">ADVERTENCIA</p><p>Si no quieres que se te quede la cara de tonto que se me quedó a mí ya en dos ocasiones, recuerda que para desmarcar opciones hay que usar &lt;Espacio&gt; y no &lt;Intro&gt;, que como le des sin querer te toca repetir todo el proceso de instalación.</p></div><ul><li>Quitar el entorno de escritorio. El servidor no lo necesitará allá donde vas a dejarlo. <em>Salvo que vayas a configurar VNC o quieras terminar de configurarlo usando una interfaz gráfica.</em></li><li>Añadir el servidor SSH, que nos permitirá conectarnos al servidor remotamente desde otro dispositivo para hacer cualquier gestión.</li></ul><h2 id="instalando-sudo" tabindex="-1">Instalando sudo <a class="header-anchor" href="#instalando-sudo" aria-label="Permalink to “Instalando sudo”">​</a></h2><p>Encendemos el servidor, iniciamos sesión con el nombre de usuario que creamos, con su contraseña y ya estaría.</p><p>Lo primero que vamos a hacer, por comodidad, es instalar el paquete <code>sudo</code>, que nos permite hacer casi todo lo que hace el usuario <code>root</code> sin necesidad de cambiarnos a ese usuario, para ello escribimos los siguientes comandos:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">su</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Contraseña:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sudo</span></span></code></pre></div><p>Ahora queda añadir al usuario que creamos durante la instalación como <em>sudoer</em>, para ello editamos el archivo <code>/etc/sudoers</code> y ponemos lo siguiente:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># This file MUST be edited with the &#39;visudo&#39; command as root.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Please consider adding local content in /etc/sudoers.d/ instead of</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># directly modifying this file.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># See the man page for details on how to write a sudoers file.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Defaults</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        env_reset</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Defaults</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        mail_badpass</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Defaults</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        secure_path=&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Host alias specification</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># User alias specification</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Cmnd alias specification</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># User privilege specification</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    ALL=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALL:ALL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ALL</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">admin</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ALL=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALL:ALL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ALL</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Allow members of group sudo to execute any command</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">%sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   ALL=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ALL:ALL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ALL</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># See sudoers(5) for more information on &quot;@include&quot; directives:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@includedir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/sudoers.d</span></span></code></pre></div><p>Donde <code>admin</code> será el usuario que creamos. Guardamos el archivo y ya podemos escribir <code>exit</code> para salirnos del usuario <code>root</code>. A partir de ahora lo normal será usar <code>sudo</code> para instalar cosas o editar archivos.</p><h2 id="anadiendo-discos-encriptados-adicionales" tabindex="-1">Añadiendo discos encriptados adicionales <a class="header-anchor" href="#anadiendo-discos-encriptados-adicionales" aria-label="Permalink to “Añadiendo discos encriptados adicionales”">​</a></h2><p>Si queremos utilizar algún disco duro adicional encriptado, necesitamos que se desencripte también y se monte al encenderse el servidor, así que vamos a ello.</p><p>Vamos a asumir que tenemos el disco ya formateado en <code>btrfs</code> y encriptado con LUKS, así que utilzamos <code>lsblk</code> para identificarlo, que en este caso es <code>sdb1</code>.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lsblk</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># NAME                    MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># sda                       8:0    0 447,1G  0 disk</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ├─sda1                    8:1    0   512M  0 part  /boot/efi</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ├─sda2                    8:2    0   488M  0 part  /boot</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># └─sda3                    8:3    0 446,2G  0 part</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   └─sda3_crypt          254:0    0 446,1G  0 crypt</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#     └─server--vg-swap_1 254:2    0   976M  0 lvm   [SWAP]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># sdb                       8:16   0   3,6T  0 disk</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># └─sdb1                    8:17   0   3,6T  0 part</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># sr0                      11:0    1  1024M  0 rom</span></span></code></pre></div><p>Lo primero es que se desencripte, para ello tendremos que añadir el disco a <code>/etc/crypttab</code>, pero como ese queremos que se desencripte solo sin tener que ponerle nosotros la contraseña, tendremos que crear un archivo que servirá como contraseña para desencriptar el disco.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/cryptsetup-keys.d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> if=/dev/urandom</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> of=/etc/cryptsetup-keys.d/vault.key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bs=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> count=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chown</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -R</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root:root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/cryptsetup-keys.d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0400</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/cryptsetup-keys.d/vault.key</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cryptsetup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> luksAddKey</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/sdb1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/cryptsetup-keys.d/vault.key</span></span></code></pre></div><p>Lo que acabamos de hacer es crear un archivo con caracteres aleatorios <em>(como una contraseña básicamente pero mucho más larga)</em> y añadirlo como clave para desencriptar el disco duro, ya que LUKS nos permite tener varias claves.</p><p>Ahora hay que buscar la UUID del disco:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -l</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/disk/by-uuid</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># total 0</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># lrwxrwxrwx 1 root root 10 ago 10 17:47 0053a965-9146-4e52-b842-0ba1a756c4c5 -&gt; ../../sda3</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># lrwxrwxrwx 1 root root 10 ago 10 17:47 1e28c433-5bf5-41e5-9708-5730bb18d0ef -&gt; ../../dm-2</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># lrwxrwxrwx 1 root root 10 ago 10 17:47 60e8d58f-cb05-47f1-85bc-38e5b0a05505 -&gt; ../../sdb1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># lrwxrwxrwx 1 root root 10 ago 10 17:47 a3313b2a-fe80-4f3c-a384-bbce92fd4301 -&gt; ../../dm-1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># lrwxrwxrwx 1 root root 10 ago 10 17:47 E283-990E -&gt; ../../sda1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># lrwxrwxrwx 1 root root 10 ago 10 17:47 eb777051-9d3a-4bf9-a186-fdfcc9d5c9c0 -&gt; ../../sda2</span></span></code></pre></div><p>Que en este caso es <code>60e8d58f-cb05-47f1-85bc-38e5b0a05505</code>, así que vamos a editar <code>/etc/crypttab</code> añadiendo esta línea al final:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>vault UUID=60e8d58f-cb05-47f1-85bc-38e5b0a05505 /etc/cryptsetup-keys.d/vault.key luks,nofail,x-systemd.device-timeout=0</span></span></code></pre></div><p>Las opciones <code>nofail</code> y <code>x-systemd.device-timeout=0</code> evitan que el sistema bloquee el arranque si no se puede desencriptar el disco.</p><p>Donde lo primero es el nombre que tendrá el volumen, lo segundo su UUID, lo tercero el archivo donde está la clave y lo cuarto especifica que utiliza LUKS.</p><p>Muy bien, con esto el disco se desencriptará al encenderse el servidor, solo nos queda añadirlo a <code>/etc/fstab</code> para que también se monte. Añadimos esta línea al final del archivo:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>/dev/mapper/vault /mnt/vault btrfs defaults,nofail 0 0</span></span></code></pre></div><p>Que hará que el disco se monte en <code>/mnt/vault</code> cuando se encienda el servidor.</p><h2 id="optimizando-discos" tabindex="-1">Optimizando discos <a class="header-anchor" href="#optimizando-discos" aria-label="Permalink to “Optimizando discos”">​</a></h2><div class="danger custom-block"><p class="custom-block-title">PELIGRO</p><p>Ten cuidado con esta parte, ya que una configuración incorrecta puede causar que el ordenador deje de encenderse correctamente, con lo que tendrás que reiniciarlo en modo de recuperación, montar el sistema temporalmente y volver a cambiar la configuración.</p></div><p><strong>Si tenemos el sistema operativo en un disco SSD SATA</strong>, como es el caso, hay unos cambios que podemos hacer para mejorar el rendimiento y la durabilidad del disco, tenemos que editar <code>/etc/fstab</code>, concretamente la primera línea sin comentar, que debería ser la correspondiente a la partición <code>root</code>, añadiendo unas opciones extra para cuando se monte:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>/dev/mapper/server--vg-root / btrfs  defaults,subvol=@rootfs,ssd,noatime,space_cache=v2,compress=zstd:2,discard=async,commit=30 0 0</span></span></code></pre></div><p>Aquí detallamos lo que hace cada opción:</p><ul><li><code>ssd</code>: Fuerza el uso de heurísticas optimizadas para SSD <em>(normalmente btrfs ya lo detecta automáticamente)</em>.</li><li><code>noatime</code>: Evita actualizar la fecha de último acceso a los archivos, reduciendo escrituras innecesarias.</li><li><code>space_cache=v2</code>: Usa el formato moderno del space cache, recomendado y por defecto en kernels recientes.</li><li><code>compress=zstd:2</code>: Activa compresión ZSTD con un buen equilibrio entre velocidad y ratio de compresión para SSD SATA.</li><li><code>discard=async</code>: Habilita TRIM de forma asíncrona, mejorando el rendimiento y la longevidad del SSD.</li><li><code>commit=30</code>: Aumenta el intervalo de escritura de metadatos a 30 segundos, reduciendo escrituras a costa de un mayor riesgo ante cortes de energía.</li></ul><p><strong>Si tenemos el sistema operativo en un disco SSD NVME M.2</strong>, como es el caso para el servidor de Minecraft, podemos utilizar las mismas opciones pero cambiando <code>compress=zstd:1</code>. En NVMe, niveles bajos de compresión suelen ofrecer el mejor equilibrio para cargas intensivas.</p><p>Para los <strong>discos duros mecánicos con btrfs</strong>, como el que vamos a usar para la partición <code>/var</code>, podemos usar estas opciones al montarlo:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>/dev/mapper/vault /var btrfs  defaults,noatime,space_cache=v2,compress=zstd:3,nofail 0 0</span></span></code></pre></div><p>En HDD la compresión aporta más beneficios. Si el procesador lo permite, se puede subir a <code>5</code> o <code>7</code>, aunque <code>3</code> es un valor equilibrado y habitual.</p><p>El resto de líneas que haya las dejamos intactas.</p><h2 id="desencriptando-el-sistema-automaticamente" tabindex="-1">Desencriptando el sistema automáticamente <a class="header-anchor" href="#desencriptando-el-sistema-automaticamente" aria-label="Permalink to “Desencriptando el sistema automáticamente”">​</a></h2><h3 id="con-tpm-2-0" tabindex="-1">Con TPM 2.0 <a class="header-anchor" href="#con-tpm-2-0" aria-label="Permalink to “Con TPM 2.0”">​</a></h3><p>Si tenemos un TPM 2.0 en el servidor, como es el caso del servidor de Minecraft, podemos hacer que el disco duro se desencripte automáticamente al encender el servidor sin necesidad de poner la contraseña.</p><p>Lo primero es verificar que el disco duro <em>(la partición donde está el sistema)</em> está encriptado con LUKS2, para ello usamos:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>sudo cryptsetup luksDump /dev/sda3 | grep Version</span></span></code></pre></div><p>Debería salir <code>Version: 2</code>, si no es así, nos tocará cambiarla desde un pendrive con un Linux live y ejecutar <code>sudo cryptsetup convert --type luks2 /dev/sda3</code>.</p><p>Ahora necesitamos instalar <code>clevis</code>:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clevis</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clevis-tpm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clevis-luks</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clevis-initramfs</span></span></code></pre></div><p>Y enlazar el volumen LUKS con el TPM:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clevis</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> luks</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bind</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/sda3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tpm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{&quot;pcr_bank&quot;:&quot;sha256&quot;,&quot;pcr_ids&quot;:&quot;2,7,11,12,14&quot;}&#39;</span></span></code></pre></div><p>Los PCRs usados son los siguientes:</p><ul><li><code>2</code> <strong>Hardware conectable (pluggable hardware):</strong> Registra cambios en la enumeración de dispositivos detectados durante el arranque temprano (PCIe, USB, Thunderbolt, controladoras, NICs, HBAs, etc.). Cambia ante modificaciones físicas relevantes del sistema, lo que permite bloquear el arranque automático si se altera el hardware.</li><li><code>7</code> <strong>Secure Boot policy:</strong> Mide si Secure Boot está habilitado y qué claves UEFI (PK, KEK, db, dbx) están activas. Garantiza que el arranque solo se desbloquee si se mantiene la política de Secure Boot esperada.</li><li><code>11</code> <strong>Imagen EFI del kernel y payload asociado:</strong> Mide el binario EFI cargado por el cargador de arranque, incluyendo el kernel como PE y cualquier initrd embebido. Detecta manipulaciones del kernel sin verse afectado por actualizaciones normales en la mayoría de configuraciones estándar.</li><li><code>12</code> <strong>Parámetros del kernel (cmdline):</strong> Registra la línea de comandos del kernel. Protege frente a cambios en parámetros críticos (<code>init=</code>, <code>root=</code>, desactivación de mitigaciones, etc.), a costa de requerir la clave si se modifica la configuración de arranque.</li><li><code>14</code> <strong>Shim y primeros componentes UEFI:</strong> Mide el binario <code>shim</code> y el inicio de la cadena de confianza UEFI. Asegura que el proceso de arranque comienza desde componentes firmados y no manipulados.</li></ul><p>Hay muchos más PCRs, pero se han seleccionado estos para equilibrar seguridad y estabilidad: el sistema se desencripta automáticamente en arranques normales, pero requiere la clave si se manipula el hardware, Secure Boot o la cadena de arranque, evitando bloqueos innecesarios por actualizaciones legítimas del sistema.</p><p>Ahora actualizamos el initramfs para que los cambios tengan efecto:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update-initramfs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -k</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span></span></code></pre></div><p>Y verificamos:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clevis</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> luks</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> list</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/sda3</span></span></code></pre></div><p>Con esto, al reiniciar el servidor, el disco debería desencriptarse automáticamente usando el TPM.</p><h3 id="sin-tpm-2-0" tabindex="-1">Sin TPM 2.0 <a class="header-anchor" href="#sin-tpm-2-0" aria-label="Permalink to “Sin TPM 2.0”">​</a></h3><p>Si tenemos un TPM 1.2, podemos utilizar <a href="https://github.com/oldium/clevis/releases/tag/v21_tpm1u7" target="_blank" rel="noreferrer">esta release</a> de clevis que soporta TPM 1.2, pero a nosotros nos dio problemas el propio TPM, así que tomamos otro enfoque.</p><p>Aprovechando que que tenemos el servidor de Minecraft que sí se desencripta solo, creamos un servicio de systemd que, al iniciarse el servidor, use <code>ssh</code> para conectarse al servidor principal y desencripte el disco. Para ello, hay que haber configurado Dropbear en el servidor principal <em>(ver <a href="./gestion-remota.html#reinicios-y-desencriptacion-del-disco">Reinicios y desencriptación del disco</a>)</em> y tener añadida la clave del servidor de Minecraft para que se pueda conectar.</p><p>Con todo eso, creamos un archivo llamado <code>/usr/local/bin/auto_unlock_server.sh</code> con el siguiente contenido:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># CONFIGURACIÓN</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TARGET_IP</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;192.168.1.XXX&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           # IP del servidor</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TARGET_PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2222&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  # El puerto dropbear configurado en servidor</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KEY_PATH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/root/.ssh/id_ed25519&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Ruta a la clave privada para autenticación SSH</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LUKS_PASSWORD</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CONTRASEÑA_DE_LUKS&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Cuidado con los caracteres especiales como $ o !</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># COMPROBACIÓN DE PUERTO</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># nc (netcat) verifica si el puerto está abierto. </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -z: modo escaneo (sin enviar datos), -w 2: timeout de 2 segundos</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> nc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -z</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -w</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$TARGET_IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$TARGET_PORT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;El servidor está esperando desbloqueo. Intentando desbloquear...&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # COMANDO DE DESBLOQUEO</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Añade -o StrictHostKeyChecking=no si Dropbear está en el mismo puerto que OpenSSH</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    printf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;%s&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$LUKS_PASSWORD</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ssh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$TARGET_PORT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$KEY_PATH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ConnectTimeout=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> UserKnownHostsFile=/dev/null</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        root@&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$TARGET_IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;cryptroot-unlock&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$?</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -eq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Comando enviado correctamente.&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Fallo al enviar el comando de desbloqueo.&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    fi</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Puerto </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$TARGET_PORT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cerrado o inalcanzable. El servidor probablemente ya está encendido o apagado.&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span></code></pre></div><p>Nos aseguramos de que solo root pueda leerlo con <code>sudo chmod 700 /usr/local/bin/auto_unlock_server.sh</code>.</p><p>Y ahora creamos un servicio de systemd en <code>/etc/systemd/system/auto-unlock-server.service</code> con este contenido:</p><div class="language-ini"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=Verificar y desbloquear servidor</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">After</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=oneshot</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ExecStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=/bin/bash /usr/local/bin/auto_unlock_server.sh</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=root</span></span></code></pre></div><p>Y un temporizador en <code>/etc/systemd/system/auto-unlock-server.timer</code>:</p><div class="language-ini"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=Ejecutar desbloqueo de servidor cada 5 minutos</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Timer]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Ejecutar 1 minuto después de arrancar el servidor</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">OnBootSec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=1min</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Ejecutar cada 5 minutos después de la última ejecución</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">OnUnitActiveSec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=5min</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WantedBy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=timers.target</span></span></code></pre></div><p>Finalmente, activamos el servicio y el temporizador:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --now</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> auto-unlock-server.timer</span></span></code></pre></div>`,111)])])}const m=a(t,[["render",r]]);export{g as __pageData,m as default};
