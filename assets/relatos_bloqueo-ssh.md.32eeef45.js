import{_ as e,c as a,o,a as r}from"./app.59171fe4.js";const n="/server/assets/panik.aba15d9f.png",s="/server/assets/kalm.1584cede.png",v=JSON.parse('{"title":"Bloqueo de SSH","description":"","frontmatter":{"title":"Bloqueo de SSH","lang":"es-ES"},"headers":[{"level":2,"title":"Contexto hist칩rico","slug":"contexto-historico","link":"#contexto-historico","children":[]},{"level":2,"title":"La cagada","slug":"la-cagada","link":"#la-cagada","children":[]},{"level":2,"title":"El rescate","slug":"el-rescate","link":"#el-rescate","children":[{"level":3,"title":"Entorno de pruebas","slug":"entorno-de-pruebas","link":"#entorno-de-pruebas","children":[]},{"level":3,"title":"Primeros enfoques","slug":"primeros-enfoques","link":"#primeros-enfoques","children":[]},{"level":3,"title":"Ahondando en el funcionamiento de Linux","slug":"ahondando-en-el-funcionamiento-de-linux","link":"#ahondando-en-el-funcionamiento-de-linux","children":[]},{"level":3,"title":"칔ltimos intentos","slug":"ultimos-intentos","link":"#ultimos-intentos","children":[]},{"level":3,"title":"Recuperando el servidor","slug":"recuperando-el-servidor","link":"#recuperando-el-servidor","children":[]}]}],"relativePath":"relatos/bloqueo-ssh.md","lastUpdated":1671014695000}'),i={name:"relatos/bloqueo-ssh.md"},t=r('<h1 id="bloqueo-de-ssh" tabindex="-1">Bloqueo de SSH <a class="header-anchor" href="#bloqueo-de-ssh" aria-hidden="true">#</a></h1><p>De cuando Iv치n escogi칩 no tener inteligencia estando lejos del servidor.</p><h2 id="contexto-historico" tabindex="-1">Contexto hist칩rico <a class="header-anchor" href="#contexto-historico" aria-hidden="true">#</a></h2><p><strong>28 de julio de 2022.</strong> El servidor, situado en Granada, estaba pendiente de casi toda configuraci칩n, solo ten칤a bien configurado Dropbear por si se reiniciaba o se iba la luz. El servidor de OpenSSH estaba aun en el puerto 22 y ten칤a activado el acceso por usuario y contrase침a.</p><p>Iv치n, estando en Valencia y sabiendo que quedaba un mes al menos hasta que pasase por Granada, decidi칩 que era buena idea cambiar el puerto de OpenSSH.</p><h2 id="la-cagada" tabindex="-1">La cagada <a class="header-anchor" href="#la-cagada" aria-hidden="true">#</a></h2><p>Primero se acord칩 de que ten칤a que abrir los puertos en el router, pero claro, para eso necesitaba configurar el servidor VNC <em>(de ah칤 surgi칩 esa parte de la gu칤a)</em> para poder meterse con Firefox a la IP del router y abrir el nuevo puerto.</p><p>Esto le mantuvo ocupado todo el d칤a, as칤 que nos trasladamos al 29 de julio, donde se dispon칤a, con los puertos abiertos en el router, a cambiar el puerto de SSH.</p><p>Cambia el puerto, reinicia el servicio SSH, cierra la conexi칩n e intenta volver a conectarse pero no funciona.</p><p><strong>HOSTIA EL FIREWALL</strong></p><p><img src="'+n+'" alt="Panik"></p><p>Efectivamente, se le hab칤a olvidado permitir el nuevo puerto de SSH en el firewall, as칤 que no hab칤a manera de poder volver a conectarse al servidor hasta que fuese a Granada.</p><h2 id="el-rescate" tabindex="-1">El rescate <a class="header-anchor" href="#el-rescate" aria-hidden="true">#</a></h2><p>Pero, 쯫 si no todo estaba perdido? Iv치n empezo a teorizar una posible forma de recuperar el servidor. Si el servidor se reiniciaba, se quedar칤a esperando a que se desencriptasen los discos duros con Dropbear, y Dropbear todav칤a estaba con el puerto 22, as칤 que si desde ah칤 fuera capaz de editar la configuraci칩n de OpenSSH, podr칤a recuperar el servidor. Solo necesitaba a alguien que reiniciase el servidor y ya podr칤a hacer el resto del trabajo.</p><p>La persona que pod칤a ir a reiniciar el servidor fue f치cil de encontrar. Pero hab칤a que hacer pruebas para ver si efectivamente era posible recuperar el servidor desde ese punto.</p><h3 id="entorno-de-pruebas" tabindex="-1">Entorno de pruebas <a class="header-anchor" href="#entorno-de-pruebas" aria-hidden="true">#</a></h3><p>Preparar el entorno de pruebas fue f치cil, pues ya ten칤a una m치quina virtual con Debian que hab칤a usado para las capturas de la gu칤a, solo ten칤a que hacer la poca configuraci칩n inicial que ten칤a el servidor y empezar a hacer pruebas.</p><h3 id="primeros-enfoques" tabindex="-1">Primeros enfoques <a class="header-anchor" href="#primeros-enfoques" aria-hidden="true">#</a></h3><p>Al principio, lo que intent칠 fue desencriptar y montar el disco manualmente desde initramfs para poder editar el archivo de configuraci칩n de OpenSSH.</p><p>Esto no dio buenos resultados porque el disco siempre se marcaba como ocupado y no dejaba montarlo.</p><h3 id="ahondando-en-el-funcionamiento-de-linux" tabindex="-1">Ahondando en el funcionamiento de Linux <a class="header-anchor" href="#ahondando-en-el-funcionamiento-de-linux" aria-hidden="true">#</a></h3><p>Como esto no funcionaba, tocaba entender mejor c칩mo funcionaba Initramfs y las fases en las que se dive, que viene bien explicado en la <a href="https://wiki.ubuntu.com/Initramfs" target="_blank" rel="noreferrer">wiki de Ubuntu</a>.</p><p>Adem치s, vi que por defecto el disco duro se montaba en solo lectura desde initramfs y, cuando segu칤a el proceso de arranque, ya se montaba escribible. As칤 que ten칤a que:</p><ul><li>Conseguir que initramfs montase el disco escribible.</li><li>Conseguir que el, una vez montado, borrase el archivo de configuraci칩n de OpenSSH para que se regenerase el por defecto.</li></ul><p>Este 칰ltimo enfoque result칩 no ser v치lido, porque OpenSSH no regenera el archivo de configuraci칩n, simplemente deja de ejecutarse. As칤 que el enfoque cambi칩 a borrar el archivo de configuraci칩n de UFW, que hace que deje de funcionar y ,por tanto, que todos los puertos est칠n abiertos desde el servidor.</p><h3 id="ultimos-intentos" tabindex="-1">칔ltimos intentos <a class="header-anchor" href="#ultimos-intentos" aria-hidden="true">#</a></h3><p>Intent칠 modificar los scripts de inicio que se ejecutan despu칠s de desencriptar el disco para que montasen el disco en escritura y borrasen el archivo de configuraci칩n, pero por mucho que cambiaba los par치metros, parec칤a no afectar y segu칤a en solo escritura.</p><p>Finalmente, ya con pocas esperanzas, el 6 de agosto decid칤 cambiar ligeramente el enfoque y editar 칰nicamente el archivo <code>/init</code>, que es el que se encarga de llamar a todos los scrips de inicio. Concretamente a침ad칤 estas l칤neas justo antes del comentario <code># Move virtual filesystems over to the real filesystem</code>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">mount -w -t btrfs -o remount </span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">ROOT</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">rootmnt</span><span style="color:#89DDFF;">}</span></span>\n<span class="line"><span style="color:#A6ACCD;">rm -f </span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">rootmnt</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">/etc/ufw/ufw.conf</span></span>\n<span class="line"><span style="color:#82AAFF;">unset</span><span style="color:#A6ACCD;"> ROOT</span></span>\n<span class="line"></span></code></pre></div><p>Borrando <code>unset ROOT</code> de m치s arriba, ya que esa variable conten칤a el nombre del disco duro con el sistema.</p><p><strong>Funcion칩.</strong> Y despu칠s de eso solo hab칤a que reinstalar y configurar de nuevo UFW.</p><h3 id="recuperando-el-servidor" tabindex="-1">Recuperando el servidor <a class="header-anchor" href="#recuperando-el-servidor" aria-hidden="true">#</a></h3><p>Sabiendo esto, solo hubo que esperar a que la persona encargada de reiniciar el servidor lo hiciese bajando y subiendo los plomos del piso.</p><p>Lo hizo y el servidor volvi칩 a la vida 游땏</p><p><img src="'+s+'" alt="Kalm"></p>',35),l=[t];function d(c,u,p,h,m,b){return o(),a("div",null,l)}const q=e(i,[["render",d]]);export{v as __pageData,q as default};
