import{_ as s,c as a,o as e,N as n}from"./chunks/framework.fe1cbe83.js";const A=JSON.parse('{"title":"Nginx como servidor web","description":"","frontmatter":{"title":"Nginx como servidor web","lang":"es-ES"},"headers":[],"relativePath":"equipo/nginx.md","lastUpdated":1681324829000}'),o={name:"equipo/nginx.md"},l=n(`<h1 id="nginx-como-servidor-web" tabindex="-1">Nginx como servidor web <a class="header-anchor" href="#nginx-como-servidor-web" aria-label="Permalink to &quot;Nginx como servidor web&quot;">‚Äã</a></h1><p>Ya nos hemos encargado de poder acceder al servidor remotamente, pero eso es solo para nosotros, queda la parte m√°s importante, el poder ofrecer alg√∫n tipo de servicio <em>(como puede ser una p√°gina web)</em>.</p><p>Para ello, necesitamos un servidor web, que se encargar√° de gestionar las conexiones entrantes. Existen dos bastante famosos:</p><ul><li><a href="https://httpd.apache.org/" target="_blank" rel="noreferrer">Apache</a></li><li><a href="https://www.nginx.com/" target="_blank" rel="noreferrer">Nginx</a></li></ul><p>Nosotros usaremos Nginx por ser m√°s moderno y m√°s eficiente.</p><h2 id="instalacion-y-puesta-en-marcha" tabindex="-1">Instalaci√≥n y puesta en marcha <a class="header-anchor" href="#instalacion-y-puesta-en-marcha" aria-label="Permalink to &quot;Instalaci√≥n y puesta en marcha&quot;">‚Äã</a></h2><p>Para asegurarnos de tener la √∫ltima versi√≥n siempre instalada, utilizaremos los repositorios de Nginx en vez de los del sistema operativo. Para a√±adirlos, podemos seguir los pasos de <a href="https://nginx.org/en/linux_packages.html#Debian" target="_blank" rel="noreferrer">su web</a>, que para Debian son:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">curl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gnupg2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ca-certificates</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">lsb-release</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">debian-archive-keyring</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">curl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://nginx.org/keys/nginx_signing.key</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">gpg</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--dearmor</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tee</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/usr/share/keyrings/nginx-archive-keyring.gpg</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">/dev/null</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gpg</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--dry-run</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--quiet</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--import</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--import-options</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">import-show</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/usr/share/keyrings/nginx-archive-keyring.gpg</span></span></code></pre></div><p>Con este √∫ltimo comando verificamos que la clave es la correcta, deber√≠a mostrarse lo siguiente:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">pub</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">rsa2048</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2011</span><span style="color:#C3E88D;">-</span><span style="color:#F78C6C;">08</span><span style="color:#C3E88D;">-</span><span style="color:#F78C6C;">19</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">SC</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">expires: </span><span style="color:#F78C6C;">2024</span><span style="color:#A6ACCD;">-</span><span style="color:#F78C6C;">06</span><span style="color:#A6ACCD;">-</span><span style="color:#F78C6C;">14</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62</span></span>
<span class="line"><span style="color:#FFCB6B;">uid</span><span style="color:#A6ACCD;">                      </span><span style="color:#C3E88D;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">signing</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">key</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">signing-key@nginx.co</span><span style="color:#A6ACCD;">m</span><span style="color:#89DDFF;">&gt;</span></span></code></pre></div><p>Nosotros hemos escogido usar los paquetes <strong>mainline</strong> en vez de los <strong>stable</strong>, la diferencia es que los primeros contienen las √∫ltimas novedades aunque pueden ser menos estables por tener caracter√≠sticas experimentales. Para a√±adir el repositorio mainline, utilizamos el siguiente comando:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] </span><span style="color:#A6ACCD;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">http://nginx.org/packages/mainline/debian </span><span style="color:#89DDFF;">\`</span><span style="color:#FFCB6B;">lsb_release</span><span style="color:#C3E88D;"> -cs</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;"> nginx</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tee</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/apt/sources.list.d/nginx.list</span></span></code></pre></div><p>Y ya ha llegado el momento de instalar Nginx:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span></code></pre></div><p>Una vez instalado, podemos iniciarlo y verificar que est√° funcionando correctamente:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">status</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span></code></pre></div><p>Sin embargo, queda un √∫ltimo paso, abrir los puertos <code>80</code> y <code>443</code> tanto en el router como en el firewall, para el firewall escribimos:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ufw</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">allow</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ufw</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">allow</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">443</span></span></code></pre></div><p>Estos son los puertos de HTTP y HTTPS respectivamente.</p><p>Vamos a toquetear un poco la configuraci√≥n para las partes venideras de la gu√≠a. La configuraci√≥n de Nginx se estructura en bloques. Concretamente la parte que tocaremos son los bloques <code>server</code>, que ser√°n la configuraci√≥n de cada uno de nuestros subdominios. Estos archivos de configuraci√≥n se guardan en <code>/etc/nginx/conf.d/</code> y, por defecto, solo habr√° un archivo llamado <code>default.conf</code>, vamos a cambiarle el nombre a <code>www.wupp.dev</code>, ya que tendr√° el bloque encargado de gestionar las conexiones con esa URL.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mv</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/nginx/conf.d/default.conf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/nginx/conf.d/www.wupp.dev.conf</span></span></code></pre></div><p>Editamos el archivo buscando una l√≠nea que empiece por <code>server_name</code>:</p><div class="language-conf"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">server_name wupp.dev www.wupp.dev;</span></span></code></pre></div><p>Ahora dejamos que Nginx verifique la sintaxis del archivo y, si no hay problemas, los reiniciamos:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-t</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">the</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">configuration</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">file</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/nginx/nginx.conf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">syntax</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ok</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">configuration</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">file</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/nginx/nginx.conf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">successful</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-s</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">reload</span></span></code></pre></div><h2 id="habilitando-y-forzando-https" tabindex="-1">Habilitando <em>(y forzando)</em> HTTPS <a class="header-anchor" href="#habilitando-y-forzando-https" aria-label="Permalink to &quot;Habilitando *(y forzando)* HTTPS&quot;">‚Äã</a></h2><p>Ahora mismo podemos poner en el navegador <a href="http://wupp.dev/" target="_blank" rel="noreferrer">wupp.dev</a>, pero la conexi√≥n no es segura üò¶</p><p>Eso es inadmisible, as√≠ que vamos a forzar a que todas las conexiones HTTP se redirijan a HTTPS. Hemos seguido <a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-20-04-es" target="_blank" rel="noreferrer">este tutorial</a>.</p><p>Vamos a utilizar Certbot, un software para gestionar los certificados de Let&#39;s Encrypt, que son <a href="https://es.wikipedia.org/wiki/Autoridad_de_certificaci%C3%B3n" target="_blank" rel="noreferrer">certificados de autoridad</a> gratuitos.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">certbot</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">python3-certbot-nginx</span></span></code></pre></div><p>Generamos el certificado para nuestro dominio:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">certbot</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-d</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wupp.dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-d</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">www.wupp.dev</span></span></code></pre></div><p>Y ya est√°, certbot se encarga de modificar la configuraci√≥n del archivo <code>/etc/nginx/conf.d/www.wupp.dev.conf</code> para forzar el uso de HTTPS y para renovar autom√°ticamente los certificados cuando vayan a expirar.</p><h2 id="otras-mejoras-de-seguridad" tabindex="-1">Otras mejoras de seguridad <a class="header-anchor" href="#otras-mejoras-de-seguridad" aria-label="Permalink to &quot;Otras mejoras de seguridad&quot;">‚Äã</a></h2><p>Aunque ya hemos asegurado que la conexi√≥n al servidor sea por HTTPS, aun quedan unos cuantos cambios por hacer para mejorar la seguridad.</p><p>Antes hemos mencionado que la configuraci√≥n de Nginx se estructura en bloques, entre los que est√°n los bloques de <code>server</code> donde iremos poniendo la configuraci√≥n de nuestros subdominios. Todos estos bloques <code>server</code> est√°n dentro de un bloque <code>http</code> en el archivo <code>/etc/nginx/nginx.conf</code>. Vamos a hacer unos cuantos cambios en ese archivo para mejorar la seguridad. As√≠ deber√≠a verse:</p><div class="language-conf"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">user  nginx;</span></span>
<span class="line"><span style="color:#A6ACCD;">worker_processes  auto;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">error_log  /var/log/nginx/error.log notice;</span></span>
<span class="line"><span style="color:#A6ACCD;">pid        /var/run/nginx.pid;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">events {</span></span>
<span class="line"><span style="color:#A6ACCD;">    worker_connections  1024;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">http {</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header Allow &quot;GET, POST, OPTIONS&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header X-Permitted-Cross-Domain-Policies &quot;none&quot; always;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header X-Content-Type-Options nosniff always;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header X-Frame-Options &quot;SAMEORIGIN&quot; always;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header X-XSS-Protection &quot;1; mode=block&quot; always;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header Referrer-Policy &quot;strict-origin-when-cross-origin&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header Content-Security-Policy &quot;default-src &#39;self&#39;;&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header Content-Security-Policy-Report-Only &quot;default-src &#39;self&#39;;&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header Permissions-Policy &quot;accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">    fastcgi_hide_header X-Powered-By;</span></span>
<span class="line"><span style="color:#A6ACCD;">    fastcgi_hide_header Server;</span></span>
<span class="line"><span style="color:#A6ACCD;">    fastcgi_hide_header X-AspNet-Version;</span></span>
<span class="line"><span style="color:#A6ACCD;">    fastcgi_hide_header X-AspNetMvc-Version;</span></span>
<span class="line"><span style="color:#A6ACCD;">    fastcgi_hide_header X-Pingback;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    # Set client_max_body_size and limit_rate</span></span>
<span class="line"><span style="color:#A6ACCD;">    client_max_body_size 10m;</span></span>
<span class="line"><span style="color:#A6ACCD;">    limit_rate 8m;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    include       /etc/nginx/mime.types;</span></span>
<span class="line"><span style="color:#A6ACCD;">    default_type  application/octet-stream;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">                      &#39;&quot;$request&quot; $status $body_bytes_sent &#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">                      &#39;&quot;$http_referer&quot; &quot;$http_user_agent&quot;&#39;;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    access_log  /var/log/nginx/access.log  main;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    # Disable server tokens in response headers</span></span>
<span class="line"><span style="color:#A6ACCD;">    server_tokens off;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    # Enable SSL/TLS</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_protocols TLSv1.2 TLSv1.3;</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_session_cache shared:le_nginx_SSL:10m;</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_session_timeout 1440m;</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_session_tickets off;</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_prefer_server_ciphers off;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    # Enable HSTS with a 1 year duration</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header Strict-Transport-Security &quot;max-age=31536000; includeSubDomains; preload&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    sendfile on;</span></span>
<span class="line"><span style="color:#A6ACCD;">    tcp_nopush on;</span></span>
<span class="line"><span style="color:#A6ACCD;">    tcp_nodelay on;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    keepalive_timeout  65;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    #gzip  on;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    include /etc/nginx/conf.d/*.conf;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span></code></pre></div><p>¬øQu√© hace cada cambio?</p><ul><li><code>add_header Allow &quot;GET, POST, OPTIONS&quot;;</code>: Indica los m√©todos HTTP que est√°n permitidos, lo que restringe la capacidad de un atacante para realizar solicitudes no autorizadas o peligrosas en el servidor web.</li><li><code>add_header X-Permitted-Cross-Domain-Policies &quot;none&quot; always;</code>: Impide que se compartan recursos con otros dominios. Esto es importante porque evita que un atacante pueda acceder a recursos del sitio web desde otro dominio.</li><li><code>add_header X-Content-Type-Options nosniff;</code>: A√±ade una cabecera HTTP para evitar que los navegadores intenten interpretar archivos con un tipo MIME incorrecto. De esta forma, se evita que un atacante pueda enviar un archivo malicioso disfrazado como un archivo seguro.</li><li><code>add_header X-Frame-Options SAMEORIGIN;</code>: A√±ade una cabecera HTTP para evitar ataques de &quot;Clickjacking&quot;, que consisten en enga√±ar al usuario para que haga clic en algo que no quiere haciendo uso de iframes. Al especificar &quot;SAMEORIGIN&quot;, se permite que la p√°gina s√≥lo sea enmarcada por otras p√°ginas que se carguen desde el mismo origen.</li><li><code>add_header X-XSS-Protection &quot;1; mode=block&quot;;</code>: A√±ade una cabecera HTTP para habilitar la protecci√≥n contra ataques XSS (Cross-Site Scripting) en los navegadores que soportan esta cabecera. Al habilitar esta protecci√≥n, se evita que un atacante pueda inyectar c√≥digo malicioso en una p√°gina web.</li><li><code>add_header Referrer-Policy &quot;strict-origin-when-cross-origin&quot;;</code>: Indica que se debe enviar informaci√≥n del referente solo para solicitudes desde el mismo origen y solicitudes de sitios de terceros que compartan el mismo origen. Esto ayuda a proteger la privacidad del usuario limitando la informaci√≥n que se comparte con sitios externos.</li><li><code>add_header Content-Security-Policy &quot;default-src &#39;self&#39;;&quot;;</code>: Especifica que solo se permiten recursos desde el mismo origen que el sitio web Esto reduce el riesgo de ataques XSS (cross-site scripting). Esto tendremos que cambiarlo en el momento en el que usemos recursos de otras p√°ginas como pueden ser fuentes de Google Fonts.</li><li><code>add_header Content-Security-Policy-Report-Only &quot;default-src &#39;self&#39;;&quot;;</code>: La diferencia de esta con la anterior es que no bloquea los recursos, sino que reporta las violaciones de la pol√≠tica. En este caso no tiene utilidad, porque es m√°s restrictiva la pol√≠tica anterior, pero igualmente la vamos a poner.</li><li><code>add_header Permissions-Policy &quot;accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()&quot;;</code>: Especifica las pol√≠ticas de permisos para los dispositivos y sensores utilizados por el sitio web.</li><li>El resto de <code>fastcgi_hide_header ...</code> ocultan qu√© software o tecnolog√≠a se utiliza para ejecutar el servidor web, que puede ser utilizado por atacantes para encontrar vulnerabilidades en el servidor.</li><li><code>client_max_body_size 10m;</code>: Establece un l√≠mite de tama√±o de solicitud m√°ximo. Esto limita el tama√±o de los datos que un usuario puede enviar en una sola solicitud para evitar ataques DDoS o intentos de cargar archivos muy grandes. Tendremos que cambiarlo dentro del bloque <code>server</code> para poder usar Nextcloud c√≥modamente.</li><li><code>limit_rate 8m;</code>: Evita que se descarguen una cantidad masiva de datos. Tambi√©n tendremos que modificarlo para Nextcloud.</li><li><code>server_tokens off;</code>: Desactiva la informaci√≥n de versi√≥n del servidor que se env√≠a en las cabeceras HTTP. De esta forma, se oculta informaci√≥n sensible y se evita que los atacantes puedan aprovechar vulnerabilidades espec√≠ficas de una versi√≥n determinada del servidor.</li><li><code>ssl_protocols TLSv1.2 TLSv1.3;</code>: Especifica que se deben utilizar los protocolos TLSv1.2 y TLSv1.3, que son versiones seguras y recomendadas de los protocolos SSL/TLS.</li><li><code>ssl_session_cache shared:le_nginx_SSL:10m</code>: Se pueden reutilizar las sesiones SSL que se han establecido previamente en una cach√© compartida llamada &quot;le_nginx_SSL&quot; con un tama√±o de 10 megabytes. Esto puede reducir la carga en el servidor.</li><li><code>ssl_session_timeout 1440m;</code>: Indica que las sesiones SSL se mantienen en cach√© durante 1440 minutos. Despu√©s de ese tiempo, las sesiones SSL caducan y se eliminan de la cach√©.</li><li><code>ssl_session_tickets off;</code>: Los tickets son una forma de guardar las sesiones SSL para m√°s tarde, pero es algo inseguro por naturaleza, as√≠ que se recomienda desactivarlo.</li><li><code>ssl_prefer_server_ciphers off;</code>: Esta opci√≥n es la recomendada si estamos limitando los protocolos a los m√°s nuevos (TLSv1.2 y TLSv1.3), porque no tienen cifrados inseguros, as√≠ que se le permite escoger al cliente el que prefiera.</li><li><code>add_header Strict-Transport-Security &quot;max-age=31536000; includeSubDomains; preload&quot;;</code>: Instruye a los navegadores a acceder al sitio web solo a trav√©s de conexiones seguras (HTTPS) durante un a√±o completo. La opci√≥n &quot;includeSubDomains&quot; extiende esta directiva a todos los subdominios y &quot;preload&quot; indica que el sitio web desea ser incluido en la lista HSTS pre-cargada de los navegadores, lo que acelera el proceso de carga de HTTPS en visitas posteriores.</li><li><code>sendfile on;</code>: Esta opci√≥n habilita el env√≠o de archivos est√°ticos directamente desde el disco a trav√©s del sistema de archivos del kernel, lo que puede mejorar significativamente el rendimiento de la entrega de archivos est√°ticos.</li><li><code>tcp_nopush on;</code>: Esta opci√≥n habilita el modo TCP_NOPUSH que evita que los paquetes de datos peque√±os se env√≠en de manera fragmentada y que los paquetes m√°s grandes se env√≠en en bloques m√°s grandes, lo que reduce la sobrecarga de env√≠o.</li><li><code>tcp_nodelay on;</code>: Esta opci√≥n habilita el modo TCP_NODELAY que deshabilita la espera antes de enviar paquetes peque√±os, lo que puede reducir la latencia en conexiones de red.</li><li><code>keepalive_timeout 65;</code>: Esta opci√≥n establece el tiempo m√°ximo de espera para mantener una conexi√≥n TCP persistente con el cliente en segundos, lo que permite una reutilizaci√≥n m√°s eficiente de las conexiones existentes y reduce la sobrecarga de establecimiento de conexiones en las solicitudes consecutivas.</li></ul><p>¬øC√≥mo hemos decidido poner estas opciones? Pues siendo sinceros, pregunt√°ndole a <a href="https://chat.openai.com" target="_blank" rel="noreferrer">ChatGPT</a> (que tambi√©n ha hecho la explicaci√≥n de qu√© hace cada cosa).</p><p>Despu√©s de esto, dentro de cada bloque <code>server</code> podremos o tendremos que hacer otros cambios, pero eso es algo espec√≠fico que iremos viendo.</p><p>Un cambio que s√≠ se puede hacer y que es √∫til si vamos a a√±adir varios subdominios (todos ellos con HTTPS), es crear un √∫nico bloque <code>server</code> que se encargue de redirigir todas las solicitudes HTTP a las respectivas HTTPS. Podemos crear un archivo <code>/etc/nginx/conf.d/wupp.dev</code> con el siguiente contenido:</p><div class="language-conf"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">server {</span></span>
<span class="line"><span style="color:#A6ACCD;">    listen 80 default_server;</span></span>
<span class="line"><span style="color:#A6ACCD;">    server_name wupp.dev;</span></span>
<span class="line"><span style="color:#A6ACCD;">    return 301 https://$server_name$request_uri;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span></code></pre></div><p>Y as√≠ el archivo <code>/etc/nginx/www.wupp.dev</code> quedar√≠a m√°s limpio:</p><div class="language-conf"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">server {</span></span>
<span class="line"><span style="color:#A6ACCD;">    server_name wupp.dev www.wupp.dev;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    #access_log  /var/log/nginx/host.access.log  main;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    location / {</span></span>
<span class="line"><span style="color:#A6ACCD;">        root   /usr/share/nginx/html;</span></span>
<span class="line"><span style="color:#A6ACCD;">        index  index.html index.htm;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    #error_page  404              /404.html;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    # redirect server error pages to the static page /50x.html</span></span>
<span class="line"><span style="color:#A6ACCD;">    #</span></span>
<span class="line"><span style="color:#A6ACCD;">    error_page   500 502 503 504  /50x.html;</span></span>
<span class="line"><span style="color:#A6ACCD;">    location = /50x.html {</span></span>
<span class="line"><span style="color:#A6ACCD;">        root   /usr/share/nginx/html;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    listen 443 ssl; # managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_certificate /etc/letsencrypt/live/wupp.dev/fullchain.pem; # managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_certificate_key /etc/letsencrypt/live/wupp.dev/privkey.pem; # managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span></code></pre></div><p>Aunque ya hemos acabado de configurar Nginx, hay que tener en cuenta de que por ahora lo √∫nico que hace es servir archivos est√°ticos localizados en <code>/usr/share/nginx/html/</code>.</p><p>En un principio, nos dedicaremos a a√±adir servicios en subdominios, dejando <code>www</code> intacto, as√≠ que puede dejarse como una p√°gina web est√°tica, retocando un poco su apariencia o puede configurarse como uno de los servicios, eso ya queda a elecci√≥n de cada uno.</p>`,47),p=[l];function r(t,c,i,d,C,u){return e(),a("div",null,p)}const D=s(o,[["render",r]]);export{A as __pageData,D as default};
