import{_ as s,c as a,o as e,N as n}from"./chunks/framework.fe1cbe83.js";const A=JSON.parse('{"title":"Nginx como servidor web","description":"","frontmatter":{"title":"Nginx como servidor web","lang":"es-ES"},"headers":[],"relativePath":"equipo/nginx.md","lastUpdated":1681324829000}'),o={name:"equipo/nginx.md"},l=n(`<h1 id="nginx-como-servidor-web" tabindex="-1">Nginx como servidor web <a class="header-anchor" href="#nginx-como-servidor-web" aria-label="Permalink to &quot;Nginx como servidor web&quot;">​</a></h1><p>Ya nos hemos encargado de poder acceder al servidor remotamente, pero eso es solo para nosotros, queda la parte más importante, el poder ofrecer algún tipo de servicio <em>(como puede ser una página web)</em>.</p><p>Para ello, necesitamos un servidor web, que se encargará de gestionar las conexiones entrantes. Existen dos bastante famosos:</p><ul><li><a href="https://httpd.apache.org/" target="_blank" rel="noreferrer">Apache</a></li><li><a href="https://www.nginx.com/" target="_blank" rel="noreferrer">Nginx</a></li></ul><p>Nosotros usaremos Nginx por ser más moderno y más eficiente.</p><h2 id="instalacion-y-puesta-en-marcha" tabindex="-1">Instalación y puesta en marcha <a class="header-anchor" href="#instalacion-y-puesta-en-marcha" aria-label="Permalink to &quot;Instalación y puesta en marcha&quot;">​</a></h2><p>Para asegurarnos de tener la última versión siempre instalada, utilizaremos los repositorios de Nginx en vez de los del sistema operativo. Para añadirlos, podemos seguir los pasos de <a href="https://nginx.org/en/linux_packages.html#Debian" target="_blank" rel="noreferrer">su web</a>, que para Debian son:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">curl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gnupg2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ca-certificates</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">lsb-release</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">debian-archive-keyring</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">curl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://nginx.org/keys/nginx_signing.key</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">gpg</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--dearmor</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tee</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/usr/share/keyrings/nginx-archive-keyring.gpg</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">/dev/null</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gpg</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--dry-run</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--quiet</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--import</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--import-options</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">import-show</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/usr/share/keyrings/nginx-archive-keyring.gpg</span></span></code></pre></div><p>Con este último comando verificamos que la clave es la correcta, debería mostrarse lo siguiente:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">pub</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">rsa2048</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2011</span><span style="color:#C3E88D;">-</span><span style="color:#F78C6C;">08</span><span style="color:#C3E88D;">-</span><span style="color:#F78C6C;">19</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">SC</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">expires: </span><span style="color:#F78C6C;">2024</span><span style="color:#A6ACCD;">-</span><span style="color:#F78C6C;">06</span><span style="color:#A6ACCD;">-</span><span style="color:#F78C6C;">14</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62</span></span>
<span class="line"><span style="color:#FFCB6B;">uid</span><span style="color:#A6ACCD;">                      </span><span style="color:#C3E88D;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">signing</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">key</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">signing-key@nginx.co</span><span style="color:#A6ACCD;">m</span><span style="color:#89DDFF;">&gt;</span></span></code></pre></div><p>Nosotros hemos escogido usar los paquetes <strong>mainline</strong> en vez de los <strong>stable</strong>, la diferencia es que los primeros contienen las últimas novedades aunque pueden ser menos estables por tener características experimentales. Para añadir el repositorio mainline, utilizamos el siguiente comando:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] </span><span style="color:#A6ACCD;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">http://nginx.org/packages/mainline/debian </span><span style="color:#89DDFF;">\`</span><span style="color:#FFCB6B;">lsb_release</span><span style="color:#C3E88D;"> -cs</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;"> nginx</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tee</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/apt/sources.list.d/nginx.list</span></span></code></pre></div><p>Y ya ha llegado el momento de instalar Nginx:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span></code></pre></div><p>Una vez instalado, podemos iniciarlo y verificar que está funcionando correctamente:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">status</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span></code></pre></div><p>Sin embargo, queda un último paso, abrir los puertos <code>80</code> y <code>443</code> tanto en el router como en el firewall, para el firewall escribimos:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ufw</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">allow</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ufw</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">allow</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">443</span></span></code></pre></div><p>Estos son los puertos de HTTP y HTTPS respectivamente.</p><p>Vamos a toquetear un poco la configuración para las partes venideras de la guía. La configuración de Nginx se estructura en bloques. Concretamente la parte que tocaremos son los bloques <code>server</code>, que serán la configuración de cada uno de nuestros subdominios. Estos archivos de configuración se guardan en <code>/etc/nginx/conf.d/</code> y, por defecto, solo habrá un archivo llamado <code>default.conf</code>, vamos a cambiarle el nombre a <code>www.wupp.dev</code>, ya que tendrá el bloque encargado de gestionar las conexiones con esa URL.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mv</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/nginx/conf.d/default.conf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/nginx/conf.d/www.wupp.dev.conf</span></span></code></pre></div><p>Editamos el archivo buscando una línea que empiece por <code>server_name</code>:</p><div class="language-conf"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">server_name wupp.dev www.wupp.dev;</span></span></code></pre></div><p>Ahora dejamos que Nginx verifique la sintaxis del archivo y, si no hay problemas, los reiniciamos:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-t</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">the</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">configuration</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">file</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/nginx/nginx.conf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">syntax</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ok</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">configuration</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">file</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/nginx/nginx.conf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">successful</span></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-s</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">reload</span></span></code></pre></div><h2 id="habilitando-y-forzando-https" tabindex="-1">Habilitando <em>(y forzando)</em> HTTPS <a class="header-anchor" href="#habilitando-y-forzando-https" aria-label="Permalink to &quot;Habilitando *(y forzando)* HTTPS&quot;">​</a></h2><p>Ahora mismo podemos poner en el navegador <a href="http://wupp.dev/" target="_blank" rel="noreferrer">wupp.dev</a>, pero la conexión no es segura 😦</p><p>Eso es inadmisible, así que vamos a forzar a que todas las conexiones HTTP se redirijan a HTTPS. Hemos seguido <a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-20-04-es" target="_blank" rel="noreferrer">este tutorial</a>.</p><p>Vamos a utilizar Certbot, un software para gestionar los certificados de Let&#39;s Encrypt, que son <a href="https://es.wikipedia.org/wiki/Autoridad_de_certificaci%C3%B3n" target="_blank" rel="noreferrer">certificados de autoridad</a> gratuitos.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">certbot</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">python3-certbot-nginx</span></span></code></pre></div><p>Generamos el certificado para nuestro dominio:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">certbot</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-d</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wupp.dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-d</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">www.wupp.dev</span></span></code></pre></div><p>Y ya está, certbot se encarga de modificar la configuración del archivo <code>/etc/nginx/conf.d/www.wupp.dev.conf</code> para forzar el uso de HTTPS y para renovar automáticamente los certificados cuando vayan a expirar.</p><h2 id="otras-mejoras-de-seguridad" tabindex="-1">Otras mejoras de seguridad <a class="header-anchor" href="#otras-mejoras-de-seguridad" aria-label="Permalink to &quot;Otras mejoras de seguridad&quot;">​</a></h2><p>Aunque ya hemos asegurado que la conexión al servidor sea por HTTPS, aun quedan unos cuantos cambios por hacer para mejorar la seguridad.</p><p>Antes hemos mencionado que la configuración de Nginx se estructura en bloques, entre los que están los bloques de <code>server</code> donde iremos poniendo la configuración de nuestros subdominios. Todos estos bloques <code>server</code> están dentro de un bloque <code>http</code> en el archivo <code>/etc/nginx/nginx.conf</code>. Vamos a hacer unos cuantos cambios en ese archivo para mejorar la seguridad. Así debería verse:</p><div class="language-conf"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">user  nginx;</span></span>
<span class="line"><span style="color:#A6ACCD;">worker_processes  auto;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">error_log  /var/log/nginx/error.log notice;</span></span>
<span class="line"><span style="color:#A6ACCD;">pid        /var/run/nginx.pid;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">events {</span></span>
<span class="line"><span style="color:#A6ACCD;">    worker_connections  1024;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">http {</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header Allow &quot;GET, POST, OPTIONS&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header X-Permitted-Cross-Domain-Policies &quot;none&quot; always;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header X-Content-Type-Options nosniff always;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header X-Frame-Options &quot;SAMEORIGIN&quot; always;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header X-XSS-Protection &quot;1; mode=block&quot; always;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header Referrer-Policy &quot;strict-origin-when-cross-origin&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header Content-Security-Policy &quot;default-src &#39;self&#39;;&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header Content-Security-Policy-Report-Only &quot;default-src &#39;self&#39;;&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header Permissions-Policy &quot;accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">    fastcgi_hide_header X-Powered-By;</span></span>
<span class="line"><span style="color:#A6ACCD;">    fastcgi_hide_header Server;</span></span>
<span class="line"><span style="color:#A6ACCD;">    fastcgi_hide_header X-AspNet-Version;</span></span>
<span class="line"><span style="color:#A6ACCD;">    fastcgi_hide_header X-AspNetMvc-Version;</span></span>
<span class="line"><span style="color:#A6ACCD;">    fastcgi_hide_header X-Pingback;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    # Set client_max_body_size and limit_rate</span></span>
<span class="line"><span style="color:#A6ACCD;">    client_max_body_size 10m;</span></span>
<span class="line"><span style="color:#A6ACCD;">    limit_rate 8m;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    include       /etc/nginx/mime.types;</span></span>
<span class="line"><span style="color:#A6ACCD;">    default_type  application/octet-stream;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">                      &#39;&quot;$request&quot; $status $body_bytes_sent &#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">                      &#39;&quot;$http_referer&quot; &quot;$http_user_agent&quot;&#39;;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    access_log  /var/log/nginx/access.log  main;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    # Disable server tokens in response headers</span></span>
<span class="line"><span style="color:#A6ACCD;">    server_tokens off;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    # Enable SSL/TLS</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_protocols TLSv1.2 TLSv1.3;</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_session_cache shared:le_nginx_SSL:10m;</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_session_timeout 1440m;</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_session_tickets off;</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_prefer_server_ciphers off;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    # Enable HSTS with a 1 year duration</span></span>
<span class="line"><span style="color:#A6ACCD;">    add_header Strict-Transport-Security &quot;max-age=31536000; includeSubDomains; preload&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    sendfile on;</span></span>
<span class="line"><span style="color:#A6ACCD;">    tcp_nopush on;</span></span>
<span class="line"><span style="color:#A6ACCD;">    tcp_nodelay on;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    keepalive_timeout  65;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    #gzip  on;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    include /etc/nginx/conf.d/*.conf;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span></code></pre></div><p>¿Qué hace cada cambio?</p><ul><li><code>add_header Allow &quot;GET, POST, OPTIONS&quot;;</code>: Indica los métodos HTTP que están permitidos, lo que restringe la capacidad de un atacante para realizar solicitudes no autorizadas o peligrosas en el servidor web.</li><li><code>add_header X-Permitted-Cross-Domain-Policies &quot;none&quot; always;</code>: Impide que se compartan recursos con otros dominios. Esto es importante porque evita que un atacante pueda acceder a recursos del sitio web desde otro dominio.</li><li><code>add_header X-Content-Type-Options nosniff;</code>: Añade una cabecera HTTP para evitar que los navegadores intenten interpretar archivos con un tipo MIME incorrecto. De esta forma, se evita que un atacante pueda enviar un archivo malicioso disfrazado como un archivo seguro.</li><li><code>add_header X-Frame-Options SAMEORIGIN;</code>: Añade una cabecera HTTP para evitar ataques de &quot;Clickjacking&quot;, que consisten en engañar al usuario para que haga clic en algo que no quiere haciendo uso de iframes. Al especificar &quot;SAMEORIGIN&quot;, se permite que la página sólo sea enmarcada por otras páginas que se carguen desde el mismo origen.</li><li><code>add_header X-XSS-Protection &quot;1; mode=block&quot;;</code>: Añade una cabecera HTTP para habilitar la protección contra ataques XSS (Cross-Site Scripting) en los navegadores que soportan esta cabecera. Al habilitar esta protección, se evita que un atacante pueda inyectar código malicioso en una página web.</li><li><code>add_header Referrer-Policy &quot;strict-origin-when-cross-origin&quot;;</code>: Indica que se debe enviar información del referente solo para solicitudes desde el mismo origen y solicitudes de sitios de terceros que compartan el mismo origen. Esto ayuda a proteger la privacidad del usuario limitando la información que se comparte con sitios externos.</li><li><code>add_header Content-Security-Policy &quot;default-src &#39;self&#39;;&quot;;</code>: Especifica que solo se permiten recursos desde el mismo origen que el sitio web Esto reduce el riesgo de ataques XSS (cross-site scripting). Esto tendremos que cambiarlo en el momento en el que usemos recursos de otras páginas como pueden ser fuentes de Google Fonts.</li><li><code>add_header Content-Security-Policy-Report-Only &quot;default-src &#39;self&#39;;&quot;;</code>: La diferencia de esta con la anterior es que no bloquea los recursos, sino que reporta las violaciones de la política. En este caso no tiene utilidad, porque es más restrictiva la política anterior, pero igualmente la vamos a poner.</li><li><code>add_header Permissions-Policy &quot;accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()&quot;;</code>: Especifica las políticas de permisos para los dispositivos y sensores utilizados por el sitio web.</li><li>El resto de <code>fastcgi_hide_header ...</code> ocultan qué software o tecnología se utiliza para ejecutar el servidor web, que puede ser utilizado por atacantes para encontrar vulnerabilidades en el servidor.</li><li><code>client_max_body_size 10m;</code>: Establece un límite de tamaño de solicitud máximo. Esto limita el tamaño de los datos que un usuario puede enviar en una sola solicitud para evitar ataques DDoS o intentos de cargar archivos muy grandes. Tendremos que cambiarlo dentro del bloque <code>server</code> para poder usar Nextcloud cómodamente.</li><li><code>limit_rate 8m;</code>: Evita que se descarguen una cantidad masiva de datos. También tendremos que modificarlo para Nextcloud.</li><li><code>server_tokens off;</code>: Desactiva la información de versión del servidor que se envía en las cabeceras HTTP. De esta forma, se oculta información sensible y se evita que los atacantes puedan aprovechar vulnerabilidades específicas de una versión determinada del servidor.</li><li><code>ssl_protocols TLSv1.2 TLSv1.3;</code>: Especifica que se deben utilizar los protocolos TLSv1.2 y TLSv1.3, que son versiones seguras y recomendadas de los protocolos SSL/TLS.</li><li><code>ssl_session_cache shared:le_nginx_SSL:10m</code>: Se pueden reutilizar las sesiones SSL que se han establecido previamente en una caché compartida llamada &quot;le_nginx_SSL&quot; con un tamaño de 10 megabytes. Esto puede reducir la carga en el servidor.</li><li><code>ssl_session_timeout 1440m;</code>: Indica que las sesiones SSL se mantienen en caché durante 1440 minutos. Después de ese tiempo, las sesiones SSL caducan y se eliminan de la caché.</li><li><code>ssl_session_tickets off;</code>: Los tickets son una forma de guardar las sesiones SSL para más tarde, pero es algo inseguro por naturaleza, así que se recomienda desactivarlo.</li><li><code>ssl_prefer_server_ciphers off;</code>: Esta opción es la recomendada si estamos limitando los protocolos a los más nuevos (TLSv1.2 y TLSv1.3), porque no tienen cifrados inseguros, así que se le permite escoger al cliente el que prefiera.</li><li><code>add_header Strict-Transport-Security &quot;max-age=31536000; includeSubDomains; preload&quot;;</code>: Instruye a los navegadores a acceder al sitio web solo a través de conexiones seguras (HTTPS) durante un año completo. La opción &quot;includeSubDomains&quot; extiende esta directiva a todos los subdominios y &quot;preload&quot; indica que el sitio web desea ser incluido en la lista HSTS pre-cargada de los navegadores, lo que acelera el proceso de carga de HTTPS en visitas posteriores.</li><li><code>sendfile on;</code>: Esta opción habilita el envío de archivos estáticos directamente desde el disco a través del sistema de archivos del kernel, lo que puede mejorar significativamente el rendimiento de la entrega de archivos estáticos.</li><li><code>tcp_nopush on;</code>: Esta opción habilita el modo TCP_NOPUSH que evita que los paquetes de datos pequeños se envíen de manera fragmentada y que los paquetes más grandes se envíen en bloques más grandes, lo que reduce la sobrecarga de envío.</li><li><code>tcp_nodelay on;</code>: Esta opción habilita el modo TCP_NODELAY que deshabilita la espera antes de enviar paquetes pequeños, lo que puede reducir la latencia en conexiones de red.</li><li><code>keepalive_timeout 65;</code>: Esta opción establece el tiempo máximo de espera para mantener una conexión TCP persistente con el cliente en segundos, lo que permite una reutilización más eficiente de las conexiones existentes y reduce la sobrecarga de establecimiento de conexiones en las solicitudes consecutivas.</li></ul><p>¿Cómo hemos decidido poner estas opciones? Pues siendo sinceros, preguntándole a <a href="https://chat.openai.com" target="_blank" rel="noreferrer">ChatGPT</a> (que también ha hecho la explicación de qué hace cada cosa).</p><p>Después de esto, dentro de cada bloque <code>server</code> podremos o tendremos que hacer otros cambios, pero eso es algo específico que iremos viendo.</p><p>Un cambio que sí se puede hacer y que es útil si vamos a añadir varios subdominios (todos ellos con HTTPS), es crear un único bloque <code>server</code> que se encargue de redirigir todas las solicitudes HTTP a las respectivas HTTPS. Podemos crear un archivo <code>/etc/nginx/conf.d/wupp.dev</code> con el siguiente contenido:</p><div class="language-conf"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">server {</span></span>
<span class="line"><span style="color:#A6ACCD;">    listen 80 default_server;</span></span>
<span class="line"><span style="color:#A6ACCD;">    server_name wupp.dev;</span></span>
<span class="line"><span style="color:#A6ACCD;">    return 301 https://$server_name$request_uri;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span></code></pre></div><p>Y así el archivo <code>/etc/nginx/www.wupp.dev</code> quedaría más limpio:</p><div class="language-conf"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">server {</span></span>
<span class="line"><span style="color:#A6ACCD;">    server_name wupp.dev www.wupp.dev;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    #access_log  /var/log/nginx/host.access.log  main;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    location / {</span></span>
<span class="line"><span style="color:#A6ACCD;">        root   /usr/share/nginx/html;</span></span>
<span class="line"><span style="color:#A6ACCD;">        index  index.html index.htm;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    #error_page  404              /404.html;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    # redirect server error pages to the static page /50x.html</span></span>
<span class="line"><span style="color:#A6ACCD;">    #</span></span>
<span class="line"><span style="color:#A6ACCD;">    error_page   500 502 503 504  /50x.html;</span></span>
<span class="line"><span style="color:#A6ACCD;">    location = /50x.html {</span></span>
<span class="line"><span style="color:#A6ACCD;">        root   /usr/share/nginx/html;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    listen 443 ssl; # managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_certificate /etc/letsencrypt/live/wupp.dev/fullchain.pem; # managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_certificate_key /etc/letsencrypt/live/wupp.dev/privkey.pem; # managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span></code></pre></div><p>Aunque ya hemos acabado de configurar Nginx, hay que tener en cuenta de que por ahora lo único que hace es servir archivos estáticos localizados en <code>/usr/share/nginx/html/</code>.</p><p>En un principio, nos dedicaremos a añadir servicios en subdominios, dejando <code>www</code> intacto, así que puede dejarse como una página web estática, retocando un poco su apariencia o puede configurarse como uno de los servicios, eso ya queda a elección de cada uno.</p>`,47),p=[l];function r(t,c,i,d,C,u){return e(),a("div",null,p)}const D=s(o,[["render",r]]);export{A as __pageData,D as default};
