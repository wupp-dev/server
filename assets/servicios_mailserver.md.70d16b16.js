import{_ as s,o as a,c as n,U as e}from"./chunks/framework.4c4a06b8.js";const d=JSON.parse('{"title":"Docker Mailserver","description":"","frontmatter":{"title":"Docker Mailserver","lang":"es-ES"},"headers":[],"relativePath":"servicios/mailserver.md","filePath":"servicios/mailserver.md","lastUpdated":1689177294000}'),o={name:"servicios/mailserver.md"},l=e(`<h1 id="docker-mailserver-correo-electronico" tabindex="-1">Docker Mailserver - Correo electrónico <a class="header-anchor" href="#docker-mailserver-correo-electronico" aria-label="Permalink to &quot;Docker Mailserver - Correo electrónico&quot;">​</a></h1><p>Tener un correo funcionando en un servidor es una tarea compleja porque un servidor de correo no se compone únicamente de un programa, suelen ser muchos que trabajan entre sí. Es por eso que, tras ver las opciones disponibles, decidimos utilizar <a href="https://github.com/docker-mailserver/docker-mailserver" target="_blank" rel="noreferrer">Docker Mailserver</a>, que (a parte de ser obviamente un servicio para docker) viene con varios complementos y tiene una instalación muy sencilla.</p><p>Hemos seguido <a href="https://docker-mailserver.github.io/docker-mailserver/latest/usage" target="_blank" rel="noreferrer">la documentación</a>, pero dejamos por aquí todos los pasos.</p><h2 id="dominio-y-router" tabindex="-1">Dominio y router <a class="header-anchor" href="#dominio-y-router" aria-label="Permalink to &quot;Dominio y router&quot;">​</a></h2><p>Lo primero que tenemos que hacer es añadir un registro <code>MX</code> al dominio base <code>wupp.dev</code> que apunte al subdominio que crearemos para el correo <code>mail.wupp.dev</code>. En el caso de FreeDNS, nos pide también una prioridad, así que pusimos <code>10:mail.wupp.dev</code> en el registro <code>MX</code>.</p><p>Después, creamos un registro <code>A</code> con el subdominio <code>mail.wupp.dev</code> y la IP del servidor.</p><p>Por último, tendremos que irnos al router y abrir los puertos <code>25</code>, <code>143</code>, <code>465</code>, <code>587</code> y <code>993</code>, que serán los usados por el correo tanto entrante como saliente.</p><h2 id="nginx-y-docker-compose" tabindex="-1">Nginx y docker-compose <a class="header-anchor" href="#nginx-y-docker-compose" aria-label="Permalink to &quot;Nginx y docker-compose&quot;">​</a></h2><p>En el <code>docker-compose.ylm</code> añadimos la <a href="https://github.com/docker-mailserver/docker-mailserver/blob/master/compose.yaml" target="_blank" rel="noreferrer">configuración de ejemplo que tienen en el repositorio</a>:</p><div class="language-yml"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">version</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">3.0</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">services</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">mailserver</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mailserver/docker-mailserver</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">container_name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mailserver</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">restart</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">always</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">env_file</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mailserver.env</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">25:25</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># SMTP  (explicit TLS =&gt; STARTTLS)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">143:143</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># IMAP4 (explicit TLS =&gt; STARTTLS)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">465:465</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># ESMTP (implicit TLS)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">587:587</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># ESMTP (explicit TLS =&gt; STARTTLS)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">993:993</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># IMAP4 (implicit TLS)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">volumes</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/dms/mail-data/:/var/mail/</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/dms/mail-state/:/var/mail-state/</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/dms/mail-logs/:/var/log/mail/</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/dms/config/:/tmp/docker-mailserver/</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/localtime:/etc/localtime:ro</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/letsencrypt:/etc/letsencrypt</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">hostname</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mail.wupp.dev</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">stop_grace_period</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">1m</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">cap_add</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">NET_ADMIN</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">healthcheck</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">test</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ss --listening --tcp | grep -P &#39;LISTEN.+:smtp&#39; || exit 1</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">timeout</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">3s</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">retries</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span></code></pre></div><p>Y creamos un archivo junto al <code>docker-compose.yml</code> con también la <a href="https://github.com/docker-mailserver/docker-mailserver/blob/master/mailserver.env" target="_blank" rel="noreferrer">configuración por defecto del repositorio</a> <code>mailserver.env</code>.</p><p>Por la longitud del archivo, me limitaré a especificar los cambios realizados en el archivo:</p><div class="language-dotenv"><button title="Copy Code" class="copy"></button><span class="lang">dotenv</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">TZ=Europe/Madrid</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">SPOOF_PROTECTION=1</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">ENABLE_OPENDKIM=0</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">ENABLE_OPENDMARC=0</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">ENABLE_POLICYD_SPF=0</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">ENABLE_CLAMAV=1</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">ENABLE_RSPAMD=1</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">RSPAMD_LEARN=1</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">RSPAMD_GREYLISTING=1</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">ENABLE_AMAVIS=0</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">ENABLE_FAIL2BAN=1</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">SSL_TYPE=letsencrypt</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">DOVECOT_MAILBOX_FORMAT=sdbox</span></span></code></pre></div><p>Como vamos a habilitar <code>TLS</code> mediante letsencrypt, tendremos que general el certificado. Nosotros hicimos temporalmente una copia de la configuración de <code>www.wupp.dev.conf</code> en Nginx para <code>mail.wupp.dev</code> y para así poder general el certificado con el comando:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">certbot</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--key-type</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ecdsa</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--elliptic-curve</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">secp384r1</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-d</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mail.wupp.dev</span></span></code></pre></div><p>Hecho todo esto, podemos ejecutar <code>docker compose up -d</code> y, rápidamente habrá que crear una primera cuenta como puede ser <code>admin@wupp.dev</code>, así que ejecutamos el siguiente comando:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">exec</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-ti</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mailserver</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">setup</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">email</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">admin@wupp.dev</span></span></code></pre></div><p>Y con esto deberíamos tener el servidor de correo correctamente funcionando.</p><h2 id="retoques-finales" tabindex="-1">Retoques finales <a class="header-anchor" href="#retoques-finales" aria-label="Permalink to &quot;Retoques finales&quot;">​</a></h2><p>Como primera recomendación, crearemos un alias para postmaster:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">exec</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-ti</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mailserver</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">setup</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">alias</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">postmaster@wupp.dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">admin@wupp.dev</span></span></code></pre></div><h2 id="¿cliente-web" tabindex="-1">¿Cliente web? <a class="header-anchor" href="#¿cliente-web" aria-label="Permalink to &quot;¿Cliente web?&quot;">​</a></h2><p><em>Posible sección.</em></p><h2 id="¿autenticacion" tabindex="-1">¿Autenticación? <a class="header-anchor" href="#¿autenticacion" aria-label="Permalink to &quot;¿Autenticación?&quot;">​</a></h2><p><em>Posible sección.</em></p>`,25),p=[l];function r(c,t,i,C,y,D){return a(),n("div",null,p)}const m=s(o,[["render",r]]);export{d as __pageData,m as default};
