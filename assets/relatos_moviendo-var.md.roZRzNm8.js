import{_ as e,c as a,o as i,ak as o}from"./chunks/framework.DtoNLqWc.js";const k=JSON.parse('{"title":"Moviendo /var a otro disco","description":"","frontmatter":{"order":5},"headers":[],"relativePath":"relatos/moviendo-var.md","filePath":"relatos/moviendo-var.md","lastUpdated":1769255157000}'),n={name:"relatos/moviendo-var.md"};function t(d,s,l,r,c,p){return i(),a("div",null,[...s[0]||(s[0]=[o(`<h1 id="moviendo-var-a-otro-disco" tabindex="-1">Moviendo /var a otro disco <a class="header-anchor" href="#moviendo-var-a-otro-disco" aria-label="Permalink to “Moviendo /var a otro disco”">​</a></h1><p>Optamos por mover toda la carpeta <code>/var</code> al disco duro grande por ser una carpeta donde se suelen almacenar logs y archivos más pesados. Para ello, montaremos directamente el disco grande en <code>/var</code>.</p><p>Primero detenemos los servicios que puedan estar usando <code>/var</code>:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsyslog</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemd-journald</span></span></code></pre></div><p>Luego copiando todo el contenido al disco duro:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -aAXH</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --numeric-ids</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --one-file-system</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/vault/</span></span></code></pre></div><p>Después modificamos <code>/etc/fstab</code> para cambiar el punto de montaje del disco duro de <code>/mnt/vault</code> a <code>/var</code> (ajustando las opciones de montaje) y tenemos que recargamos la configuración de systemd con <code>sudo systemctl daemon-reload</code>.</p><p>Ahora podemos mover la actual carpeta a una copia y mantenerla durante un tiempo prudencial <code>sudo mv /var /var.old</code>, creamos la nueva carpeta <code>sudo mkdir /var</code> y remontamos el disco duro con <code>sudo umount /mnt/vault</code> y <code>sudo mount /dev/mapper/vault</code>.</p><p>Cuando comprobemos que todo funciona bien, podemos borrar la copia antigua con <code>sudo rm -rf /var.old</code>.</p><h2 id="docker" tabindex="-1">Docker <a class="header-anchor" href="#docker" aria-label="Permalink to “Docker”">​</a></h2><p>Si tenemos Docker, lo mejor es que <code>/var/lib/docker</code> esté dentro del SSD, porque si no notaremos una gran lentitud al usar contenedores. Para ello, con docker parado (<code>sudo systemctl stop docker</code>), movemos la carpeta a una ubicación dentro del SSD, por ejemplo a <code>/docker</code>:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span></span></code></pre></div><p>Después, creamos de nuevo la carpeta <code>/var/lib/docker</code> y creamos un enlace simbólico apuntando a la nueva ubicación:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/docker</span></span></code></pre></div><p>Y ahora podríamos elegir entre un enlace simbólico o un bind mount. Nosotros optamos por el bind mount porque nos parecía más limpio:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bind</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/docker</span></span></code></pre></div><p>Y para asegurar que se monta automáticamente al iniciar el sistema, añadimos esta línea a <code>/etc/fstab</code>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>/docker  /var/lib/docker  none  bind  0  0</span></span></code></pre></div><p>Ahora ya podemos iniciar Docker de nuevo con <code>sudo systemctl start docker</code>.</p><h2 id="posibles-problemas" tabindex="-1">Posibles problemas <a class="header-anchor" href="#posibles-problemas" aria-label="Permalink to “Posibles problemas”">​</a></h2><p>Si después de esto obtuviésemos un error al usar <code>apt</code> similar a:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>/usr/bin/mandb: can&#39;t chmod /var/cache/man/CACHEDIR.TAG: Operation not permitted</span></span>
<span class="line"><span>/usr/bin/mandb: can&#39;t remove /var/cache/man/CACHEDIR.TAG: Permission denied</span></span>
<span class="line"><span>/usr/bin/mandb: fopen /var/cache/man/28371: Permission denied</span></span></code></pre></div><p>Podemos solucionarlo con <code>chown -R man: /var/cache/man/</code> y <code>chmod -R 755 /var/cache/man/</code>.</p><p>También es posible que, después de eso, nos encontremos con que el servicio <code>lighdm</code> falla (posiblemente después de un reinicio). Lo podemos solucionar con <code>sudo chown -R lightdm:lightdm /var/lib/lightdm/</code> y <code>sudo chmod -R 755 /var/lib/lightdm/</code>.</p><p>Otra de las cosas que pueden ocurrir es que el servicio <code>binfmt-support</code> falle también después de un reinicio. Lo podemos solucionar con <code>mkdir /etc/systemd/system/binfmt-support.service.d</code> y creando el archivo <code>/etc/systemd/system/binfmt-support.service.d/override.conf</code> con:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>[Unit]</span></span>
<span class="line"><span>RequiresMountsFor=/var</span></span></code></pre></div><p>Que hará que el servicio se inicie una vez se haya montado la partición <code>/var</code>.</p>`,27)])])}const u=e(n,[["render",t]]);export{k as __pageData,u as default};
