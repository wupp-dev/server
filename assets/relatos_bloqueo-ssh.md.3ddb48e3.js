import{_ as e,o as a,c as o,U as s}from"./chunks/framework.4c4a06b8.js";const r="/server/assets/panik.aba15d9f.png",n="/server/assets/kalm.1584cede.png",f=JSON.parse('{"title":"Bloqueo de SSH","description":"","frontmatter":{"title":"Bloqueo de SSH","lang":"es-ES"},"headers":[],"relativePath":"relatos/bloqueo-ssh.md","filePath":"relatos/bloqueo-ssh.md","lastUpdated":1691266442000}'),i={name:"relatos/bloqueo-ssh.md"},t=s('<h1 id="bloqueo-de-ssh" tabindex="-1">Bloqueo de SSH <a class="header-anchor" href="#bloqueo-de-ssh" aria-label="Permalink to &quot;Bloqueo de SSH&quot;">‚Äã</a></h1><p>De cuando Iv√°n escogi√≥ no tener inteligencia estando lejos del servidor.</p><h2 id="contexto-historico" tabindex="-1">Contexto hist√≥rico <a class="header-anchor" href="#contexto-historico" aria-label="Permalink to &quot;Contexto hist√≥rico&quot;">‚Äã</a></h2><p><strong>28 de julio de 2022.</strong> El servidor, situado en Granada, estaba pendiente de casi toda configuraci√≥n, solo ten√≠a bien configurado Dropbear por si se reiniciaba o se iba la luz. El servidor de OpenSSH estaba aun en el puerto 22 y ten√≠a activado el acceso por usuario y contrase√±a.</p><p>Iv√°n, estando en Valencia y sabiendo que quedaba un mes al menos hasta que pasase por Granada, decidi√≥ que era buena idea cambiar el puerto de OpenSSH.</p><h2 id="la-cagada" tabindex="-1">La cagada <a class="header-anchor" href="#la-cagada" aria-label="Permalink to &quot;La cagada&quot;">‚Äã</a></h2><p>Primero se acord√≥ de que ten√≠a que abrir los puertos en el router, pero claro, para eso necesitaba configurar el servidor VNC <em>(de ah√≠ surgi√≥ esa parte de la gu√≠a)</em> para poder meterse con Firefox a la IP del router y abrir el nuevo puerto.</p><p>Esto le mantuvo ocupado todo el d√≠a, as√≠ que nos trasladamos al 29 de julio, donde se dispon√≠a, con los puertos abiertos en el router, a cambiar el puerto de SSH.</p><p>Cambia el puerto, reinicia el servicio SSH, cierra la conexi√≥n e intenta volver a conectarse pero no funciona.</p><p><strong>HOSTIA EL FIREWALL</strong></p><p><img src="'+r+'" alt="Panik"></p><p>Efectivamente, se le hab√≠a olvidado permitir el nuevo puerto de SSH en el firewall, as√≠ que no hab√≠a manera de poder volver a conectarse al servidor hasta que fuese a Granada.</p><h2 id="el-rescate" tabindex="-1">El rescate <a class="header-anchor" href="#el-rescate" aria-label="Permalink to &quot;El rescate&quot;">‚Äã</a></h2><p>Pero, ¬øy si no todo estaba perdido? Iv√°n empezo a teorizar una posible forma de recuperar el servidor. Si el servidor se reiniciaba, se quedar√≠a esperando a que se desencriptasen los discos duros con Dropbear, y Dropbear todav√≠a estaba con el puerto 22, as√≠ que si desde ah√≠ fuera capaz de editar la configuraci√≥n de OpenSSH, podr√≠a recuperar el servidor. Solo necesitaba a alguien que reiniciase el servidor y ya podr√≠a hacer el resto del trabajo.</p><p>La persona que pod√≠a ir a reiniciar el servidor fue f√°cil de encontrar. Pero hab√≠a que hacer pruebas para ver si efectivamente era posible recuperar el servidor desde ese punto.</p><h3 id="entorno-de-pruebas" tabindex="-1">Entorno de pruebas <a class="header-anchor" href="#entorno-de-pruebas" aria-label="Permalink to &quot;Entorno de pruebas&quot;">‚Äã</a></h3><p>Preparar el entorno de pruebas fue f√°cil, pues ya ten√≠a una m√°quina virtual con Debian que hab√≠a usado para las capturas de la gu√≠a, solo ten√≠a que hacer la poca configuraci√≥n inicial que ten√≠a el servidor y empezar a hacer pruebas.</p><h3 id="primeros-enfoques" tabindex="-1">Primeros enfoques <a class="header-anchor" href="#primeros-enfoques" aria-label="Permalink to &quot;Primeros enfoques&quot;">‚Äã</a></h3><p>Al principio, lo que intent√© fue desencriptar y montar el disco manualmente desde initramfs para poder editar el archivo de configuraci√≥n de OpenSSH.</p><p>Esto no dio buenos resultados porque el disco siempre se marcaba como ocupado y no dejaba montarlo.</p><h3 id="ahondando-en-el-funcionamiento-de-linux" tabindex="-1">Ahondando en el funcionamiento de Linux <a class="header-anchor" href="#ahondando-en-el-funcionamiento-de-linux" aria-label="Permalink to &quot;Ahondando en el funcionamiento de Linux&quot;">‚Äã</a></h3><p>Como esto no funcionaba, tocaba entender mejor c√≥mo funcionaba Initramfs y las fases en las que se dive, que viene bien explicado en la <a href="https://wiki.ubuntu.com/Initramfs" target="_blank" rel="noreferrer">wiki de Ubuntu</a>.</p><p>Adem√°s, vi que por defecto el disco duro se montaba en solo lectura desde initramfs y, cuando segu√≠a el proceso de arranque, ya se montaba escribible. As√≠ que ten√≠a que:</p><ul><li>Conseguir que initramfs montase el disco escribible.</li><li>Conseguir que el, una vez montado, borrase el archivo de configuraci√≥n de OpenSSH para que se regenerase el por defecto.</li></ul><p>Este √∫ltimo enfoque result√≥ no ser v√°lido, porque OpenSSH no regenera el archivo de configuraci√≥n, simplemente deja de ejecutarse. As√≠ que el enfoque cambi√≥ a borrar el archivo de configuraci√≥n de UFW, que hace que deje de funcionar y ,por tanto, que todos los puertos est√©n abiertos desde el servidor.</p><h3 id="ultimos-intentos" tabindex="-1">√öltimos intentos <a class="header-anchor" href="#ultimos-intentos" aria-label="Permalink to &quot;√öltimos intentos&quot;">‚Äã</a></h3><p>Intent√© modificar los scripts de inicio que se ejecutan despu√©s de desencriptar el disco para que montasen el disco en escritura y borrasen el archivo de configuraci√≥n, pero por mucho que cambiaba los par√°metros, parec√≠a no afectar y segu√≠a en solo escritura.</p><p>Finalmente, ya con pocas esperanzas, el 6 de agosto decid√≠ cambiar ligeramente el enfoque y editar √∫nicamente el archivo <code>/init</code>, que es el que se encarga de llamar a todos los scrips de inicio. Concretamente a√±ad√≠ estas l√≠neas justo antes del comentario <code># Move virtual filesystems over to the real filesystem</code>:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">mount</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-w</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-t</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">btrfs</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-o</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">remount</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">ROOT</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">rootmnt</span><span style="color:#89DDFF;">}</span></span>\n<span class="line"><span style="color:#FFCB6B;">rm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-f</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">rootmnt</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">/etc/ufw/ufw.conf</span></span>\n<span class="line"><span style="color:#82AAFF;">unset</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ROOT</span></span></code></pre></div><p>Borrando <code>unset ROOT</code> de m√°s arriba, ya que esa variable conten√≠a el nombre del disco duro con el sistema.</p><p><strong>Funcion√≥.</strong> Y despu√©s de eso solo hab√≠a que reinstalar y configurar de nuevo UFW.</p><h3 id="recuperando-el-servidor" tabindex="-1">Recuperando el servidor <a class="header-anchor" href="#recuperando-el-servidor" aria-label="Permalink to &quot;Recuperando el servidor&quot;">‚Äã</a></h3><p>Sabiendo esto, solo hubo que esperar a que la persona encargada de reiniciar el servidor lo hiciese bajando y subiendo los plomos del piso.</p><p>Lo hizo y el servidor volvi√≥ a la vida üòÑ</p><p><img src="'+n+'" alt="Kalm"></p>',35),l=[t];function c(d,p,u,m,b,h){return a(),o("div",null,l)}const v=e(i,[["render",c]]);export{f as __pageData,v as default};
