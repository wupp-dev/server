import{_ as s,o as a,c as n,U as l}from"./chunks/framework.4c4a06b8.js";const F=JSON.parse('{"title":"Nextcloud","description":"","frontmatter":{"title":"Nextcloud","lang":"es-ES"},"headers":[],"relativePath":"servicios/nextcloud.md","filePath":"servicios/nextcloud.md","lastUpdated":1691251004000}'),o={name:"servicios/nextcloud.md"},p=l(`<h1 id="nextcloud-almacenamiento" tabindex="-1">Nextcloud - Almacenamiento <a class="header-anchor" href="#nextcloud-almacenamiento" aria-label="Permalink to &quot;Nextcloud - Almacenamiento&quot;">​</a></h1><p>Por fin llegó el momento de poner en marcha el primer servicio, y qué mejor elección que <a href="https://nextcloud.com/es/" target="_blank" rel="noreferrer">Nextcloud</a>. Antes de empezar asegúrate de que tienes un subdominio creado para Nextcloud como <code>cloud.wupp.dev</code>.</p><h2 id="configurando-docker" tabindex="-1">Configurando Docker <a class="header-anchor" href="#configurando-docker" aria-label="Permalink to &quot;Configurando Docker&quot;">​</a></h2><p>Empezamos escribiendo en el <code>docker-compose.yml</code> todo lo necesario para tener una instalación funcional de Nextcloud:</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">services</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">nextcloud-db</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">postgres</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">restart</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">always</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">environment</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">POSTGRES_USER=nextcloud</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">POSTGRES_PASSWORD=pwd</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">POSTGRES_DB=nextcloud</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">volumes</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/lib/nextcloud/postgresql/data:/var/lib/postgresql:Z</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">nextcloud-redis</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">redis</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">redis-server --requirepass pwd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">nextcloud</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nextcloud:fpm</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">restart</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">always</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">depends_on</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nextcloud-db</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nextcloud-redis</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">environment</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">POSTGRES_HOST=nextcloud-db</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">NEXTCLOUD_TRUSTED_DOMAINS=cloud.wupp.dev</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">REDIS_HOST=nextcloud-redis</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">REDIS_HOST_PORT=6379</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">REDIS_HOST_PASSWORD=pwd</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PHP_MEMORY_LIMIT=50G</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PHP_UPLOAD_LIMIT=50G</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">9000:9000</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">volumes</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/www/nextcloud:/var/www/html</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">nextcloud-cron</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nextcloud:fpm</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">restart</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">always</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">depends_on</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nextcloud-db</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nextcloud-redis</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">volumes</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/www/nextcloud:/var/www/html</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">entrypoint</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/cron.sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">nextcloud-imaginary</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nextcloud/aio-imaginary:latest</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">restart</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">always</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">9090:9000</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-concurrency 20 -enable-url-source -return-size</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">cap_add</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">SYS_NICE</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Hemos decidido usar PostgreSQL como base de datos para Nextcloud por preferencia personal, pero se puede configurar sin mucha distinción con MariaDB, que es de hecho como empezarmos a usarlo.</p></div><p>Lo primero que cabe destacar es que en este nuevo archivo, los usuarios y las contraseñas están directamente escritos. Esto no es una buena práctica de seguridad, pero para la guía lo vamos a dejar así, dejando claro que a la hora de implementarlo deberían usarse <a href="https://docs.docker.com/engine/swarm/secrets/" target="_blank" rel="noreferrer">secretos de docker</a>. Una excepción que hemos hecho a esto es redis, que por unos cuantos problemas que nos ha dado lo hemos dejado sin contraseña, aunque se puede usar con contraseña siempre que esté escrita en el <code>docker-compose.yml</code> en el comando de iniciación de redis (y se le pase a Nextcloud).</p><p>Vamos a analizar un poco el documento, concretamente los servicios que hay declarados:</p><ul><li><code>nextcloud-db</code>: Esta será la base de datos de Nextcloud. En <code>environment</code> simplemente se establece un usuario, contraseña y base de datos a crear, que serán para Nextcloud. Por último, <code>volumes</code> permite que los datos guardados se conserven aunque el servicio se reinicie y la <code>Z</code> la puso Lucas en por verla en la documentación, <a href="https://docs.docker.com/storage/bind-mounts/#configure-the-selinux-label" target="_blank" rel="noreferrer">aquí</a> se explica lo que hace.</li><li><code>nextcloud-redis</code>: Es otra base de datos pero que en este caso Nextcloud utilizará para almacenar archivos en caché y así tener un mejor rendimiento. También se usará para gestionar los inicios de sesión. En <code>command</code> se puede especificar la contraseña.</li><li><code>nextcloud</code>: Tiene el mapeo de puertos <code>9000:9000</code> para que Nginx pueda redirigir las solicitudes PHP dentro del contenedor. Además, <code>depends_on</code> indica que tanto <code>nextcloud-db</code> como <code>nextcloud-redis</code> deben estar funcionando para que Nextcloud lo haga. Por último se hace igual que en <code>nextcloud-db</code> un mapeo de carpetas para conservar los datos y se establecen las variables de entorno para configurar Nextcloud.</li><li><code>nextcloud-cron</code>: Este contenedor es peculiar. Es necesario solo si planeas que Nextcloud lo vaya a usar más de una persona, para reducir la carga de trabajo del servidor. Lo único que hace es ejecutar puntualmente una tarea de <code>cron</code> dentro de los archivos de Nextcloud para hacer labores de mantenimiento y limpieza de forma automática.</li><li><code>nextcloud-imaginary</code>: La imagen actualizada por Nextcloud de <a href="https://github.com/h2non/imaginary" target="_blank" rel="noreferrer">Imaginary</a>, un microservicio encargado de generar las vistas previas de las imágenes subidas a Nextcloud. No es estrictamente necesario, pero es más rápido que la aplicación que tiene Nextcloud para ello.</li></ul><p>Para que Nextcloud empiece a ejecutarse (aunque aun no podamos acceder) simplemente escribimos <code>docker compose up -d</code>.</p><h2 id="configurando-nginx" tabindex="-1">Configurando Nginx <a class="header-anchor" href="#configurando-nginx" aria-label="Permalink to &quot;Configurando Nginx&quot;">​</a></h2><p>Con el <code>docker-compose.yml</code> configurado, podemos pasar a configurar el subdominio para Nextcloud en Nginx. La mayor parte de la configuración la hemos tomado de <a href="https://github.com/nextcloud/docker/blob/master/.examples/docker-compose/insecure/postgres/fpm/web/nginx.conf" target="_blank" rel="noreferrer">este ejemplo</a>, pero añadiendo HTTPS y cambiando unas cuantas cosas. Creamos el archivo <code>/etc/nginx/conf.d/cloud.wupp.dev.conf</code> con el contenido:</p><div class="language-nginx"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">upstream</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">nextcloud </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:9000;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Set the \`immutable\` cache control options only for assets with a cache busting \`v\` argument</span></span>
<span class="line"><span style="color:#C792EA;">map</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;font-style:italic;">arg_v</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">asset_immutable {</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">&quot;&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">&quot;&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> default</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">&quot;immutable&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">server</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> server_name </span><span style="color:#A6ACCD;">cloud.wupp.dev</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">http2</span><span style="color:#A6ACCD;"> on</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># set max upload size</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> client_max_body_size </span><span style="color:#A6ACCD;">50G</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># unlimited download speed</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> limit_rate </span><span style="color:#A6ACCD;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> fastcgi_buffers </span><span style="color:#A6ACCD;">64 </span><span style="color:#F78C6C;">4K</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Enable gzip but do not remove ETag headers</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> gzip </span><span style="color:#A6ACCD;">on</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> gzip_vary </span><span style="color:#A6ACCD;">on</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> gzip_comp_level </span><span style="color:#A6ACCD;">4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> gzip_min_length </span><span style="color:#A6ACCD;">256</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> gzip_proxied </span><span style="color:#A6ACCD;">expired no-cache no-store private no_last_modified no_etag auth</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> gzip_types </span><span style="color:#A6ACCD;">application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/wasm application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># The settings allows you to optimize the HTTP2 bandwitdth.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># See https://blog.cloudflare.com/delivering-http-2-upload-speed-improvements/</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># for tunning hints</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> client_body_buffer_size </span><span style="color:#A6ACCD;">512k</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># HTTP response headers</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> add_header </span><span style="color:#A6ACCD;">X-Download-Options </span><span style="color:#C3E88D;">&quot;noopen&quot;</span><span style="color:#A6ACCD;"> always</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> add_header </span><span style="color:#A6ACCD;">X-Robots-Tag </span><span style="color:#C3E88D;">&quot;noindex, nofollow&quot;</span><span style="color:#A6ACCD;"> always</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> add_header </span><span style="color:#A6ACCD;">X-Content-Type-Options nosniff always</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> add_header </span><span style="color:#A6ACCD;">X-Frame-Options </span><span style="color:#C3E88D;">&quot;SAMEORIGIN&quot;</span><span style="color:#A6ACCD;"> always</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> add_header </span><span style="color:#A6ACCD;">X-XSS-Protection </span><span style="color:#C3E88D;">&quot;1; mode=block&quot;</span><span style="color:#A6ACCD;"> always</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> add_header </span><span style="color:#A6ACCD;">Referrer-Policy </span><span style="color:#C3E88D;">&quot;no-referrer&quot;</span><span style="color:#A6ACCD;"> always</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> add_header </span><span style="color:#A6ACCD;">X-Permitted-Cross-Domain-Policies </span><span style="color:#C3E88D;">&quot;none&quot;</span><span style="color:#A6ACCD;"> always</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> add_header </span><span style="color:#A6ACCD;">Strict-Transport-Security </span><span style="color:#C3E88D;">&quot;max-age=31536000; includeSubDomains; preload&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Add .mjs as a file extension for javascript</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Either include it in the default mime.types list</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># or include you can include that list explicitly and add the file extension</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># only for Nextcloud like below:</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> include </span><span style="color:#A6ACCD;">mime.types</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">types</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">        application/javascript mjs</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Path to the root of your installation</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> root </span><span style="color:#A6ACCD;">/var/www/nextcloud</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Specify how to handle directories -- specifying \`/index.php$request_uri\`</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># here as the fallback means that Nginx always exhibits the desired behaviour</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># when a client requests a path that corresponds to a directory that exists</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># on the server. In particular, if that directory contains an index.php file,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># that file is correctly served; if it doesn&#39;t, then the request is passed to</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># the front-end controller. This consistent behaviour means that we don&#39;t need</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># to specify custom rules for certain paths (e.g. images and other assets,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># \`/updater\`, \`/ocm-provider\`, \`/ocs-provider\`), and thus</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># \`try_files $uri $uri/ /index.php$request_uri\`</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># always provides the desired behaviour.</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> index </span><span style="color:#A6ACCD;">index.php index.html /index.php</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">request_uri</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Rule borrowed from \`.htaccess\` to handle Microsoft DAV clients</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> ( </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">http_user_agent </span><span style="color:#89DDFF;">~ </span><span style="color:#A6ACCD;">^DavClnt ) </span><span style="color:#F07178;">{</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">302</span><span style="color:#F07178;"> /remote.php/webdav/</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">is_args</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">args</span><span style="color:#F07178;">;</span></span>
<span class="line"><span style="color:#F07178;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/robots.txt </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> allow </span><span style="color:#A6ACCD;">all</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> log_not_found </span><span style="color:#A6ACCD;">off</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> access_log </span><span style="color:#A6ACCD;">off</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Make a regex exception for \`/.well-known\` so that clients can still</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># access it despite the existence of the regex rule</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># \`location ~ /(\\.|autotest|...)\` which would otherwise handle requests</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># for \`/.well-known\`.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">^~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/.well-known </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># The rules in this block are an adaptation of the rules</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># in \`.htaccess\` that concern \`/.well-known\`.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/.well-known/carddav </span><span style="color:#A6ACCD;">{ </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">301</span><span style="color:#A6ACCD;"> /remote.php/dav/; }</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/.well-known/caldav  </span><span style="color:#A6ACCD;">{ </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">301</span><span style="color:#A6ACCD;"> /remote.php/dav/; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/.well-known/acme-challenge    </span><span style="color:#A6ACCD;">{</span><span style="color:#89DDFF;"> try_files $</span><span style="color:#A6ACCD;">uri </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">uri/ </span><span style="color:#F78C6C;">=404</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> }</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/.well-known/pki-validation    </span><span style="color:#A6ACCD;">{</span><span style="color:#89DDFF;"> try_files $</span><span style="color:#A6ACCD;">uri </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">uri/ </span><span style="color:#F78C6C;">=404</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># Let Nextcloud&#39;s API for \`/.well-known\` URIs handle all other</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># requests by passing them to the front-end controller.</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">301</span><span style="color:#A6ACCD;"> /index.php</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">request_uri;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Rules borrowed from \`.htaccess\` to hide certain paths from clients</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">^/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/)  </span><span style="color:#A6ACCD;">{ </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">404</span><span style="color:#A6ACCD;">; }</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">^/(?:\\.|autotest|occ|issue|indie|db_|console)                </span><span style="color:#A6ACCD;">{ </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">404</span><span style="color:#A6ACCD;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Ensure this block, which passes PHP files to the PHP process, is above the blocks</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># which handle static assets (as seen below). If this block is not declared first,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># then Nginx will encounter an infinite rewriting loop when it prepends \`/index.php\`</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># to the URI, resulting in a HTTP 500 error response.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">\\.php(?:$|/) </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># Required for legacy support</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">rewrite</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">^/(?!index|remote|public|cron|core\\/ajax\\/update|status|ocs\\/v[12]|updater\\/.+|oc[ms]-provider\\/.+|.+\\/richdocumentscode\\/proxy) /index.php$</span><span style="color:#A6ACCD;">request_uri</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> fastcgi_split_path_info </span><span style="color:#C3E88D;">^(.+?\\.php)(/.*)$</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> set $</span><span style="color:#A6ACCD;">path_info </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">fastcgi_path_info</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> try_files $</span><span style="color:#A6ACCD;">fastcgi_script_name </span><span style="color:#F78C6C;">=404</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> include </span><span style="color:#A6ACCD;">fastcgi_params</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> fastcgi_param </span><span style="color:#A6ACCD;">SCRIPT_FILENAME /var/www/html/</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">fastcgi_script_name</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> fastcgi_param </span><span style="color:#A6ACCD;">PATH_INFO </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">path_info</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> fastcgi_param </span><span style="color:#A6ACCD;">HTTPS</span><span style="color:#89DDFF;"> on;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> fastcgi_param </span><span style="color:#A6ACCD;">modHeadersAvailable</span><span style="color:#89DDFF;"> true;</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;"># Avoid sending the security headers twice</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> fastcgi_param </span><span style="color:#A6ACCD;">front_controller_active</span><span style="color:#89DDFF;"> true;</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;font-style:italic;"># Enable pretty urls</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> fastcgi_pass </span><span style="color:#A6ACCD;">nextcloud</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> fastcgi_intercept_errors </span><span style="color:#A6ACCD;">on</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> fastcgi_request_buffering </span><span style="color:#A6ACCD;">off</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> fastcgi_max_temp_file_size </span><span style="color:#A6ACCD;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> fastcgi_read_timeout </span><span style="color:#A6ACCD;">600</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">\\.(?:css|js|svg|gif|png|jpg|ico|wasm|tflite|map)$ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> try_files $</span><span style="color:#A6ACCD;">uri /index.php</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">request_uri</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> expires </span><span style="color:#A6ACCD;">6M</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;"># Cache-Control policy borrowed from \`.htaccess\`</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> access_log </span><span style="color:#A6ACCD;">off</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;font-style:italic;"># Optional: Don&#39;t log access to assets</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">\\.wasm$ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#89DDFF;"> default_type </span><span style="color:#A6ACCD;">application/wasm</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">\\.woff2?$ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> try_files $</span><span style="color:#A6ACCD;">uri /index.php</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">request_uri</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> expires </span><span style="color:#A6ACCD;">7d</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;"># Cache-Control policy borrowed from \`.htaccess\`</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> access_log </span><span style="color:#A6ACCD;">off</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;font-style:italic;"># Optional: Don&#39;t log access to assets</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Rule borrowed from \`.htaccess\`</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/remote </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">301</span><span style="color:#A6ACCD;"> /remote.php</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">request_uri;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> try_files $</span><span style="color:#A6ACCD;">uri </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">uri/ /index.php</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">request_uri</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> listen </span><span style="color:#A6ACCD;">443 ssl</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> ssl_certificate </span><span style="color:#A6ACCD;">/etc/letsencrypt/live/cloud.wupp.dev/fullchain.pem</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> ssl_certificate_key </span><span style="color:#A6ACCD;">/etc/letsencrypt/live/cloud.wupp.dev/privkey.pem</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> include </span><span style="color:#A6ACCD;">/etc/letsencrypt/options-ssl-nginx.conf</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> ssl_dhparam </span><span style="color:#A6ACCD;">/etc/letsencrypt/ssl-dhparams.pem</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># managed by Certbot</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span></code></pre></div><p>Como puntos a destacar, se ha puesto un límite de cuerpo de 50GB para permitir que se suban archivos de hasta 50G en consonancia con la configuración de <code>docker-compose.yml</code>. Además, se ha quitado el límite de velocidad de transferencia.</p><p>También se vuelven a especificar todas las cabeceras HTTP a pesar de que las pusimos en el bloque <code>http</code> de Nginx, donde está contenido nuestro bloque actual. ¿Por qué? Porque las cabeceras HTTP definidas en un bloque superior solo se heredan al siguiente si en ese no hay ninguna cabecera definida y, en este caso, había que definir sí o sí cabeceras nuevas, así que hay que añadir las que se quieran conservar.</p><p>Por último (y este cambio es puñetero), como PHP se está ejecutando dentro de Docker, para PHP los archivos no están en <code>/var/www/nextcloud</code>, están en <code>/var/www/html</code>, así que hay que cambiarlo en <code>fastcgi_param SCRIPT_FILENAME</code> o, de lo contrario, el servidor solo devolverá un mensaje de &quot;File not found&quot;.</p><p>¡Ojo! Que no se nos olvide generar el certificado HTTPS para el subdominio <code>cloud.wupp.dev</code>. Después, comprobamos que el archivo está bien con <code>sudo nginx -t</code> y si lo está, lo recargamos con <code>sudo nginx -s reload</code>.</p><h2 id="configurando-nextcloud" tabindex="-1">Configurando Nextcloud <a class="header-anchor" href="#configurando-nextcloud" aria-label="Permalink to &quot;Configurando Nextcloud&quot;">​</a></h2><p>Una vez hecho esto, deberíamos de poder acceder a <code>cloud.wupp.dev</code> y nos aparecería la pantalla de configuración inicial de Nexcloud, donde debemos elegir un nombre de usuario y contraseña para la cuenta de administrador. Para la base de datos, elegimos &quot;MySQL/MariaDB&quot; y ponemos el nombre de usuario, contraseña y la base de datos para Nextcloud que pusimos en <code>docker-compose.yml</code>. Por último, para la dirección escribimos <code>nextcloud-db:3306</code>.</p><p>Ya habiendo instalado Nextcloud, podemos navegar por los ajustes y configurarlo, aunque también podemos hacerlo modificando los archivos de configuración como <code>/var/www/nextcloud/config/config.php</code>. Por ejemplo, podemos añadir estas líneas al final:</p><div class="language-php"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">default_language</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">es</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">default_locale</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">es_ES</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">default_phone_region</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">ES</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">bulkupload.enabled</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span></span>
<span class="line"><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">enabledPreviewProviders</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">TXT</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">MarkDown</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">PDF</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">MSOfficeDoc</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">JPEG</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">PNG</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">GIF</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">BMP</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">XBitmap</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">MP3</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">HEIC</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Movie</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">MKV</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">MP4</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">AVI</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">MP3</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">OpenDocument</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Krita</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">OC</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Preview</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">Imaginary</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">],</span></span>
<span class="line"><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">preview_imaginary_url</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http://127.0.0.1:9090</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span></code></pre></div><p>Concretamente, la línea <code>&#39;bulkupload.enabled&#39; =&gt; false,</code> ayuda a solucionar un <a href="https://github.com/nextcloud/desktop/issues/5094" target="_blank" rel="noreferrer">bug</a> que hay actualmente con el cliente de Nextcloud al tener la velocidad de subida ilimitada. Y las últimas líneas son la configuración de Imaginary.</p><p>A parte de eso, como Nextcloud funciona con PHP, nos conviene modificar también la configuración de PHP. Y esto puede ser un poco lioso, porque en la imagen de docker que tenemos hay muchos archivos que modifican la configuración de PHP. Además, esos archivos no los podemos modificar directamente porque al reiniciar el contenedor se borran. La solución es crear un nuevo archivo con las opciones que queremos cambiar y copiarlo dentro del contenedor de docker cada vez que se inicie.</p><p>Para empezar creamos el archivo <code>/var/www/nextcloud/manual-php.ini</code> y ponemos el siguiente contenido:</p><div class="language-ini"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">; Manual configuration for PHP</span></span>
<span class="line"><span style="color:#F07178;">max_input_time</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> -1</span></span>
<span class="line"><span style="color:#F07178;">max_execution_time</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> 172800</span></span>
<span class="line"><span style="color:#F07178;">max_file_uploads</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> 10000</span></span>
<span class="line"><span style="color:#F07178;">max_input_nesting_level</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> 128</span></span>
<span class="line"><span style="color:#F07178;">max_input_vars</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> 10000</span></span></code></pre></div><p>Estos valores se pueden ajustar al gusto de cada uno. Después, solo tendremos que añadir a <code>docker-compose.yml</code> la línea <code>/var/www/nextcloud/manual-php.ini:/usr/local/etc/php/conf.d/manual-php.ini</code> como volumen de Nextcloud y reiniciar los contenedores de docker.</p><p>Finalmente, podemos añadir un poco más de seguridad siguiendo <a href="https://docs.nextcloud.com/server/latest/admin_manual/installation/harden_server.html#setup-fail2ban" target="_blank" rel="noreferrer">estas recomendaciones</a> del manual de Nextcloud.</p>`,27),e=[p];function c(t,r,D,y,i,C){return a(),n("div",null,e)}const d=s(o,[["render",c]]);export{F as __pageData,d as default};
