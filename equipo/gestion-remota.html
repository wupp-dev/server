<!DOCTYPE html>
<html lang="es-ES" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gesti√≥n remota | WUPP</title>
    <meta name="description" content="Gu√≠a del servidor.">
    <meta name="generator" content="VitePress v2.0.0-alpha.15">
    <link rel="preload stylesheet" href="/server/assets/style.BtZV9p0D.css" as="style">
    <link rel="preload stylesheet" href="/server/vp-icons.css" as="style">
    
    <script type="module" src="/server/assets/app.D1egUEub.js"></script>
    <link rel="preload" href="/server/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/server/assets/chunks/theme.DetAURT4.js">
    <link rel="modulepreload" href="/server/assets/chunks/framework.DtoNLqWc.js">
    <link rel="modulepreload" href="/server/assets/equipo_gestion-remota.md.BVEQ1oui.lean.js">
    <link rel="icon" href="/server/favicon.ico">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-0df3b126><!--[--><!--]--><!--[--><span tabindex="-1" data-v-e4b96250></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-e4b96250>Saltar al contenido</a><!--]--><!----><header class="VPNav" data-v-0df3b126 data-v-473c5363><div class="VPNavBar" data-v-473c5363 data-v-67ba061d><div class="wrapper" data-v-67ba061d><div class="container" data-v-67ba061d><div class="title" data-v-67ba061d><div class="VPNavBarTitle has-sidebar" data-v-67ba061d data-v-7999d162><a class="title" href="/server/" data-v-7999d162><!--[--><!--]--><!--[--><img class="VPImage logo" src="/server/favicon.svg" alt data-v-50a24257><!--]--><span data-v-7999d162>WUPP</span><!--[--><!--]--></a></div></div><div class="content" data-v-67ba061d><div class="content-body" data-v-67ba061d><!--[--><!--]--><div class="VPNavBarSearch search" data-v-67ba061d><!--[--><!----><div id="local-search"><button type="button" aria-label="Buscar" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Buscar</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-67ba061d data-v-38f2c859><span id="main-nav-aria-label" class="visually-hidden" data-v-38f2c859> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/server/" tabindex="0" data-v-38f2c859 data-v-10b58a00><!--[--><span data-v-10b58a00>Inicio</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/server/nosotros" tabindex="0" data-v-38f2c859 data-v-10b58a00><!--[--><span data-v-10b58a00>Nosotros</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/server/equipo/historia" tabindex="0" data-v-38f2c859 data-v-10b58a00><!--[--><span data-v-10b58a00>Gu√≠a del servidor</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://github.com/wupp-dev/server/tree/main/fs" target="_blank" rel="noreferrer" tabindex="0" data-v-38f2c859 data-v-10b58a00><!--[--><span data-v-10b58a00>Archivos de configuraci√≥n</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-67ba061d data-v-4f29e3f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-4f29e3f0 data-v-12f8bd23 data-v-d3c87a43><span class="check" data-v-d3c87a43><span class="icon" data-v-d3c87a43><!--[--><span class="vpi-sun sun" data-v-12f8bd23></span><span class="vpi-moon moon" data-v-12f8bd23></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-67ba061d data-v-d313260a data-v-d12a472e><!--[--><a class="VPSocialLink no-icon" href="https://github.com/wupp-dev/server/" aria-label="Repositorio GitHub de este proyecto" target="_blank" rel="me noopener" data-v-d12a472e data-v-7425dcfe><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-67ba061d data-v-c3d7f22d data-v-002ae00f><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-002ae00f><span class="vpi-more-horizontal icon" data-v-002ae00f></span></button><div class="menu" data-v-002ae00f><div class="VPMenu" data-v-002ae00f data-v-681df21c><!----><!--[--><!--[--><!----><div class="group" data-v-c3d7f22d><div class="item appearance" data-v-c3d7f22d><p class="label" data-v-c3d7f22d>Apariencia</p><div class="appearance-action" data-v-c3d7f22d><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-c3d7f22d data-v-12f8bd23 data-v-d3c87a43><span class="check" data-v-d3c87a43><span class="icon" data-v-d3c87a43><!--[--><span class="vpi-sun sun" data-v-12f8bd23></span><span class="vpi-moon moon" data-v-12f8bd23></span><!--]--></span></span></button></div></div></div><div class="group" data-v-c3d7f22d><div class="item social-links" data-v-c3d7f22d><div class="VPSocialLinks social-links-list" data-v-c3d7f22d data-v-d12a472e><!--[--><a class="VPSocialLink no-icon" href="https://github.com/wupp-dev/server/" aria-label="Repositorio GitHub de este proyecto" target="_blank" rel="me noopener" data-v-d12a472e data-v-7425dcfe><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-67ba061d data-v-c39e5934><span class="container" data-v-c39e5934><span class="top" data-v-c39e5934></span><span class="middle" data-v-c39e5934></span><span class="bottom" data-v-c39e5934></span></span></button></div></div></div></div><div class="divider" data-v-67ba061d><div class="divider-line" data-v-67ba061d></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-0df3b126 data-v-af343012><div class="container" data-v-af343012><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-af343012><span class="vpi-align-left menu-icon" data-v-af343012></span><span class="menu-text" data-v-af343012>Men√∫</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-af343012 data-v-e499510b><button data-v-e499510b>Volver arriba</button><!----></div></div></div><aside class="VPSidebar" data-v-0df3b126 data-v-0bcf3316><div class="curtain" data-v-0bcf3316></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-0bcf3316><span class="visually-hidden" id="sidebar-aria-label" data-v-0bcf3316> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-42831e0c><section class="VPSidebarItem level-0 has-active" data-v-42831e0c data-v-7114ee1f><div class="item" role="button" tabindex="0" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><h2 class="text" data-v-7114ee1f>Equipo</h2><!----></div><div class="items" data-v-7114ee1f><!--[--><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/equipo/historia" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Historia</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/equipo/hardware" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Hardware</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/equipo/sistema-encriptado" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Instalaci√≥n del SO encriptado</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/equipo/router-dominio" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Router y dominio</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/equipo/gestion-remota" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Gesti√≥n remota</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/equipo/nginx" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Servidor web</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/equipo/docker" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Docker</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/equipo/mariadb-docker" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Base de datos</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/equipo/monitorizacion" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Monitorizaci√≥n</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/equipo/conectando-servidores" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Conectando servidores</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/equipo/copias-seguridad" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Copias de seguridad</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-42831e0c><section class="VPSidebarItem level-0" data-v-42831e0c data-v-7114ee1f><div class="item" role="button" tabindex="0" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><h2 class="text" data-v-7114ee1f>Servicios</h2><!----></div><div class="items" data-v-7114ee1f><!--[--><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/servicios/nextcloud" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Nextcloud - Almacenamiento</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/servicios/mailserver" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Docker Mailserver - Correo electr√≥nico</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/servicios/minio" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>MinIO - Almacenamiento S3</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/servicios/minecraft" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Minecraft con AMP</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/servicios/navidrome" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Navidrome - Streaming de m√∫sica</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-42831e0c><section class="VPSidebarItem level-0" data-v-42831e0c data-v-7114ee1f><div class="item" role="button" tabindex="0" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><h2 class="text" data-v-7114ee1f>Relatos</h2><!----></div><div class="items" data-v-7114ee1f><!--[--><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/relatos/bloqueo-ssh" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Bloqueo de SSH</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/relatos/docker" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Docker y sus cosas</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/relatos/dns-initramfs" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Resoluci√≥n de dominios en initramfs</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/relatos/tunel-ssh-ulp" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>T√∫nel SSH en la UGR LAN Party de 2024</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-7114ee1f data-v-7114ee1f><div class="item" data-v-7114ee1f><div class="indicator" data-v-7114ee1f></div><a class="VPLink link link" href="/server/relatos/moviendo-var" data-v-7114ee1f><!--[--><p class="text" data-v-7114ee1f>Moviendo /var a otro disco</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-0df3b126 data-v-0aaaad75><div class="VPDoc has-sidebar has-aside" data-v-0aaaad75 data-v-6fb275ed><!--[--><!--]--><div class="container" data-v-6fb275ed><div class="aside" data-v-6fb275ed><div class="aside-curtain" data-v-6fb275ed></div><div class="aside-container" data-v-6fb275ed><div class="aside-content" data-v-6fb275ed><div class="VPDocAside" data-v-6fb275ed data-v-15fffdd4><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-15fffdd4 data-v-67194202><div class="content" data-v-67194202><div class="outline-marker" data-v-67194202></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-67194202>En esta p√°gina</div><ul class="VPDocOutlineItem root" data-v-67194202 data-v-b6c34609><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-15fffdd4></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-6fb275ed><div class="content-container" data-v-6fb275ed><!--[--><!--]--><main class="main" data-v-6fb275ed><div style="position:relative;" class="vp-doc _server_equipo_gestion-remota external-link-icon-enabled" data-v-6fb275ed><div><h1 id="gestion-remota-con-ssh-y-vnc" tabindex="-1">Gesti√≥n remota con SSH y VNC <a class="header-anchor" href="#gestion-remota-con-ssh-y-vnc" aria-label="Permalink to ‚ÄúGesti√≥n remota con SSH y VNC‚Äù">‚Äã</a></h1><p>Esta secci√≥n incluye todas las cosas que hay que hacer en el servidor antes de poder guardarlo, olvidarte de √©l y, con suerte, no volver a necesitar enchufarle un monitor y un teclado para gestionarlo.</p><h2 id="breve-introduccion" tabindex="-1">Breve introducci√≥n <a class="header-anchor" href="#breve-introduccion" aria-label="Permalink to ‚ÄúBreve introducci√≥n‚Äù">‚Äã</a></h2><p>Un servidor es un ordenador al que no quieres tenerle conectado ni un monitor ni un teclado <em>(el rat√≥n no existe)</em> porque no deber√≠as tener que tocarlo directamente salvo para el mantenimiento f√≠sico y cambios en la UEFI o en el sistema operativo.</p><p>Pero s√≠ que hay que conectarse a √©l habitualmente para instalar y desinstalar software y para configurarlo. Esto lo haremos desde otros dispositivos usando el protocolo <em>Secure Shell (SSH)</em>, que nos permitir√° ejecutar comandos en el servidor, transferir archivos y otras cosas m√°s chulas que veremos despu√©s. Todo ello con una conexi√≥n cifrada üòÑ</p><p>Es aqu√≠ donde se nos plantea un gran problema: Cuando nos podemos conectar al servidor mediante SSH es cuando est√° encendido <em>(y con los discos desencriptados)</em>, pero ¬øy si no estamos en casa y el ordenador se ha tenido que reiniciar o ha habido un apag√≥n? Entonces el ordenador se quedar√≠a esperando a que pusi√©ramos <em>(¬°con un teclado!)</em> la contrase√±a para desencriptar los discos y as√≠ poder seguir encendi√©ndose. Eso no mola. Deber√≠amos de poder desencriptar el ordenador remotamente tambi√©n para no tener miedo.</p><p>Este problema lo resolveremos tras preparar el servidor para el uso habitual.</p><div class="warning custom-block"><p class="custom-block-title">ADVERTENCIA</p><p>Aunque estoy seguro de que es por culpa del router que usamos. En nuestro caso, si el servidor no tiene ning√∫n tipo de interacci√≥n a trav√©s de Internet durante unos minutos, el router deja de permitir conexiones a √©l. Para ahorrarnos el disgusto de intentar conectarnos y descubrir que el router no nos lo va a permitir porque el servidor haya estado &quot;inactivo&quot;, tendremos que forzar una actividad peri√≥dica m√≠nima (como hacer un ping) tanto cuando el ordenador est√© encendido como cuando est√© esperando a que se introduzca la contrase√±a para desencriptar los discos.</p></div><h2 id="uso-habitual" tabindex="-1">Uso habitual <a class="header-anchor" href="#uso-habitual" aria-label="Permalink to ‚ÄúUso habitual‚Äù">‚Äã</a></h2><p>Vamos a empezar dejando lista nuestra v√≠a para poder gestionar remotamente el servidor cuando est√© encendido.</p><p>Como lo elegimos a la hora de instalar Debian, el servidor ya viene con OpenSSH Server instalado, que por defecto se ejecuta en el puerto <code>22</code>.</p><div class="info custom-block"><p class="custom-block-title custom-block-title-default">INFO</p><p>Puedes elegir no usar el puerto 22 para SSH para evitar los ataques automatizados que intentan entrar en los servidores a trav√©s de ese puerto por defecto. Sin embargo, si realizas toda la configuraci√≥n de esta p√°gina y limitas la autenticaci√≥n al uso de claves p√∫blicas, no hay ning√∫n problema en usar el puerto 22 salvo porque puedas tener algo m√°s de &quot;ruido&quot; en los logs.</p></div><p>Sin embargo, si intentamos conectarnos desde otro ordenador, no nos dejar√°, por dos motivos:</p><ul><li>Tenemos que abrir el puerto en el router <em>(si no lo hicimos antes)</em>.</li><li>Tenemos que permitirlo en el firewall <em>(si tenemos uno)</em>.</li></ul><p>As√≠ que lo que hay que hacer es primero abrir el puerto SSH en el router y, si tenemos un firewall, permitirlo tambi√©n. <strong>Si no tenemos un firewall, vamos a instalarlo porque es necesario.</strong> Para ello ejecutamos los siguientes comandos:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ufw</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ufw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> allow</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 22/tcp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ufw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span></span></code></pre></div><p>Donde <code>22</code> es el puerto de SSH y <code>tcp</code> el protocolo. Con esto ya tenemos el firewall configurado para aceptar conexiones SSH.</p><p>Ahora ya podr√≠amos conectarnos al servidor desde otro ordenador utilizando la contrase√±a del usuario. Eso quiere decir que alguien (o algo) puede ponerse probar contrase√±as a ver si acierta y compromete nuestro servidor, cosa que queremos evitar, as√≠ que vamos a utilizar la autenticaci√≥n por clave p√∫blica.</p><p><img src="/server/assets/conexion-ssh.BkpKm3E9.jpg" alt="Conexi√≥n SSH"></p><p>Para configurarla en el ordenador del que nos vayamos a conectar, seguiremos <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server" target="_blank" rel="noreferrer">este tutorial</a>. Adem√°s, tiene al final una parte de configuraci√≥n que tambi√©n se debe hacer y viene incluido m√°s adelante en la gu√≠a.</p><h2 id="reinicios-y-desencriptacion-del-disco" tabindex="-1">Reinicios y desencriptaci√≥n del disco <a class="header-anchor" href="#reinicios-y-desencriptacion-del-disco" aria-label="Permalink to ‚ÄúReinicios y desencriptaci√≥n del disco‚Äù">‚Äã</a></h2><p>Adem√°s de poder configurar el desencriptado autom√°tico descrito <a href="/server/equipo/sistema-encriptado#desencriptando-el-sistema-automaticamente">aqu√≠</a>, tenemos que tener alguna forma de conectarnos y desencriptar el disco remotamente en caso de que el servidor se reinicie o se apague por cualquier motivo y el m√©todo autom√°tico falle.</p><p>Para ello, existe un paquete de Debian llamado <code>dropbear-initramfs</code> que nos va a permitir hacer justo lo que queremos. <strong>¬øQu√© es lo que hace?</strong> Pues para eso hay que entender un poco c√≥mo se enciende un ordenador con Linux y los discos encriptados.</p><p>El disco duro realmente no est√° encriptado del todo, tiene una partici√≥n llamada boot que √∫nicamente contiene la informaci√≥n necesaria para decirle al ordenador cuando se intenta encender c√≥mo debe hacerlo. Aqu√≠ entra el sistema <code>initrd</code>, que son los archivos b√°sicos que se cargan en la RAM cuando el ordenador se enciende y que, junto con el kernel de Linux, se ocupan de gestionar el encendido. Puedes ver una descripci√≥n m√°s detallada en <a href="https://wiki.ubuntu.com/Initramfs" target="_blank" rel="noreferrer">esta p√°gina</a>.</p><p>Teniendo en cuenta lo anterior, <code>dropbear-initramfs</code> es un software que permite que el servidor reciba conexiones SSH en esta fase del encendido, justo a tiempo para introducir la contrase√±a para desencriptar los discos.</p><p>Se instala como cualquier otro paquete normal y corriente escribiendo:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dropbear-initramfs</span></span></code></pre></div><p><strong>¬øEso es todo?</strong> Obviamente no, hay que configurarlo.</p><p>Vamos a editar el archivo de configuraci√≥n, que est√° en <code>/etc/dropbear/initramfs/dropbear.conf</code> y vamos a descomentar y editar la l√≠nea:</p><div class="language-ssh-config"><button title="Copy Code" class="copy"></button><span class="lang">ssh-config</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DROPBEAR_OPTIONS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&quot;-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">I</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 300</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -j -k -p </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2222</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -s&quot;</span></span></code></pre></div><p>¬øQu√© significa esto?</p><ul><li><code>-I 300</code> desconecta a quien en 300 segundos no ha realizado ninguna acci√≥n.</li><li><code>-j</code> deshabilita la redirecci√≥n de puertos locales.</li><li><code>-k</code> deshabilita la redirecci√≥n de puertos remotos.</li><li><code>-p 2222</code> indica que se ejecute en el puerto 2222. Es recomendable cambiarlo a otro puerto distinto al de OpenSSH Server para evitar conflictos.</li><li><code>-s</code> deshabilita la autenticaci√≥n por contrase√±a.</li></ul><p>Como indica el √∫ltimo par√°metro, la autenticaci√≥n por contrase√±a est√° deshabilitada, as√≠ que utilizaremos tambi√©n las claves p√∫blicas que hayamos autorizado para OpenSSH Server, podemos copiarlas y hacer que los cambios tengan efecto con los comandos:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /home/admin/.ssh/authorized_keys</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/dropbear-initramfs/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update-initramfs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">ADVERTENCIA</p><p>Si en alg√∫n momento a√±ades o modificar las claves autorizadas para conectarte a OpenSSH Server, recuerda copiar el archivo de nuevo y ejecutar <code>sudo update-initramfs -u</code> para que los cambios tengan efecto en Dropbear.</p></div><p>Esto generar√° de nuevo en la partici√≥n <code>boot</code> los archivos de <code>initramfs</code> incluyendo los cambios que hemos hecho.</p><div class="tip custom-block"><p class="custom-block-title">MINI-RELATO</p><p>Tras esto descubr√≠ que si el ordenador permanec√≠a mucho tiempo encendido sin que nadie se conectase para desencriptar los discos, dejaba de ser accesible a trav√©s de la IP p√∫blica o el dominio (aunque s√≠ era posible acceder a trav√©s de la IP local). Al principio pens√© que era porque hab√≠a que configurar la IP fija en <code>initramfs</code>, pero al intentar hacerlo, como el router ya ten√≠a fijada la IP, se hac√≠an un l√≠o y no funcionaba. Al final se solucion√≥ al poner tambi√©n ah√≠ el dominio a actualizarse, que es justo lo que viene ahora en la gu√≠a.</p></div><h3 id="¬øy-que-pasa-con-el-dominio" tabindex="-1">¬øY qu√© pasa con el dominio? <a class="header-anchor" href="#¬øy-que-pasa-con-el-dominio" aria-label="Permalink to ‚Äú¬øY qu√© pasa con el dominio?‚Äù">‚Äã</a></h3><p>¬øNo podr√≠a ocurrir que, tras ese apag√≥n o reinicio, la IP p√∫blica cambie? Pues s√≠, podr√≠a ocurrir. Y no nos conviene, as√≠ que vamos a asegurarnos de que el dominio se actualice correctamente.</p><p>El objetivo es crear una tarea de <code>crontab</code> para ir actualizando la IP cada cierto tiempo durante el encendido. El primer problema que nos encontramos para esto es que los comandos disponibles cuando estamos en <code>√¨nitramfs</code> son muy pocos y no incluyen <code>crontab</code>. Concretamente, los comandos que hay disponibles son una versi√≥n reducida de <a href="https://busybox.net/" target="_blank" rel="noreferrer">BusyBox</a> y para poder usar <code>crontab</code> necesitamos la versi√≥n completa.</p><p><code>initramfs</code> utiliza la versi√≥n de BusyBox que haya instalada en Debian, as√≠ que tenemos que cambiarla escribiendo <code>sudo apt install busybox-static</code>, que reemplazar√° a la anterior y se incluir√° autom√°ticamente en <code>initramfs</code>.</p><div class="danger custom-block"><p class="custom-block-title">PELIGRO</p><p>Aunque seguramente no sea el caso, puede ser que al hacer esto se cree una incompatibilidad entre la nueva versi√≥n de BusyBox y el resto de componentes de <code>initramfs</code>, haciendo que el servidor no pueda encenderse, as√≠ que recomiendo hacer una copia de seguridad por si algo sale mal.</p></div><p>Despu√©s de esto <code>crontab</code> ya estar√° disponible, pero no funcionar√° porque en <code>initramfs</code> el directorio donde se guarda por defecto el archivo con la configuraci√≥n no existe. La forma de resolverlo es creando el archivo <code>/usr/share/initramfs-tools/hooks/crontab</code> con este contenido:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/sh -e</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;prereqs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/share/initramfs-tools/hook-functions</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DESTDIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DESTDIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/spool</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DESTDIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/spool/cron</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DESTDIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/spool/cron/crontabs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/share/initramfs-tools/crontab</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DESTDIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/spool/cron/crontabs/root</span></span></code></pre></div><p>Escribimos <code>sudo chmod +x /usr/share/initramfs-tools/hooks/crontab</code> para hacer el archivo ejecutable y esto lo que har√° es crear el directorio y copiar un archivo con la configuraci√≥n de <code>crontab</code> que vamos a crear ahora mismo. Escribimos en <code>/usr/share/initramfs-tools/crontab</code> la l√≠nea necesaria para actualizar √∫nicamente <code>wupp.dev</code>, ya que el resto de subdominios nos da igual que se actualicen ahora si no van a poder usarse porque el ordenador no est√° completamente encendido:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>1,6,11,16,21,26,31,36,41,46,51,56 * * * * sleep 46 ; wget --no-check-certificate -qO- ipinfo.io/ip -O - | xargs -I {} wget --no-check-certificate -qO- &quot;https://dynamicdns.park-your-domain.com/update?host=@&amp;domain=wupp.dev&amp;password=passwd&amp;ip={}&quot; &gt; /tmp/dnsupdate.log 2&gt;&amp;1 &amp;</span></span></code></pre></div><p>Y restringimos los permisos del archivo escribiendo:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chown</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root:root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/share/initramfs-tools/crontab</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/share/initramfs-tools/crontab</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">ADVERTENCIA</p><p>Por mucho que hayamos restringido los permisos del archivo, se va a guardar en una partici√≥n que no est√° cifrada, as√≠ que cualquiera que pueda acceder al disco podr√° ver el token y &quot;secuestrar&quot; nuestro dominio para redirigirlo a donde quiera. Tenlo en cuenta.</p></div><p>Cada vez que ejecutemos <code>sudo update-initramfs -u</code> se volver√° a crear el directorio y a copiar el archivo, con lo que tambi√©n nos aseguraremos de que si cambiamos el archivo tambi√©n se cambiar√° en <code>initramfs</code>, aunque no inmediatamente.</p><p>Sin embargo, aunque ya podemos usar <code>crontab</code> en <code>initramfs</code>, nos falta hacer que se empiece a ejecutar, as√≠ que tenemos que crear otro archivo que se encargue de iniciar <code>crond</code>, que ejecutar√° lo que haya en <code>crontab</code>. Ese archivo ser√° <code>/usr/share/initramfs-tools/scripts/init-premount/crond</code> y tendr√° este contenido:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/sh</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Start crond</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PREREQ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;busybox&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prereqs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$PREREQ</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> $1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> in</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">prereqs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        prereqs</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">esac</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /scripts/functions</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">crond</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -l</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre></div><p>Que no se nos olvide hacer el archivo ejecutable escribiendo <code>sudo chmod +x /usr/share/initramfs-tools/scripts/init-premount/crond</code>.</p><p>Genial, ahora si probamos a reiniciar el ordenador nos encontraremos con otro problema, y es que la resoluci√≥n de dominios no funciona. Podemos comprobarlo con un comando tan sencillo como <code>wget google.com</code>, que nos dar√° un error.</p><div class="tip custom-block"><p class="custom-block-title">RELATO</p><p>La informaci√≥n que hay en Internet sobre c√≥mo hacer funcionar la resoluci√≥n de dominios en <code>initramfs</code> es casi nula, as√≠ que la forma en la que lo conseguimos fue con varias pruebas que puedes consultar <a href="./../relatos/dns-initramfs">aqu√≠</a>.</p></div><p>Para arreglarlo, crearemos un √∫ltimo archivo <code>/usr/share/initramfs-tools/hooks/dns</code> con el contenido:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/sh -e</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;prereqs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/share/initramfs-tools/hook-functions</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/lib/x86_64-linux-gnu/libnss_dns.so.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DESTDIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/usr/lib/x86_64-linux-gnu/libnss_dns.so.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/resolv.conf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DESTDIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/etc/resolv.conf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/host.conf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DESTDIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/etc/host.conf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/hosts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DESTDIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/etc/hosts</span></span></code></pre></div><p>Y lo hacemos ejecutable con <code>sudo chmod +x /usr/share/initramfs-tools/hooks/dns</code>. Hecho esto ejecutamos una √∫ltima vez <code>sudo update-initramfs -u</code> y ya estar√≠a.</p><h2 id="resolviendo-problemas" tabindex="-1">Resolviendo problemas <a class="header-anchor" href="#resolviendo-problemas" aria-label="Permalink to ‚ÄúResolviendo problemas‚Äù">‚Äã</a></h2><p>Un problema con el que nos podemos encontrar cuando intentamos conectarnos al servidor por SSH primero para desencriptar los discos y despu√©s para el uso normal, es que nos salta este error tras escribir <code>ssh admin@wupp.dev</code>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span></span>
<span class="line"><span>@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @</span></span>
<span class="line"><span>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span></span>
<span class="line"><span>IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!</span></span>
<span class="line"><span>Someone could be eavesdropping on you right now (man-in-the-middle attack)!</span></span>
<span class="line"><span>It is also possible that a host key has just been changed.</span></span>
<span class="line"><span>The fingerprint for the ED25519 key sent by the remote host is</span></span>
<span class="line"><span>SHA256:I9TWN1skf97h/X9sJgevzZT1kZZQ9hFRQadccKljr7I.</span></span>
<span class="line"><span>Please contact your system administrator.</span></span>
<span class="line"><span>Add correct host key in /home/user/.ssh/known_hosts to get rid of this message.</span></span>
<span class="line"><span>Offending ECDSA key in /home/user/.ssh/known_hosts:2</span></span>
<span class="line"><span>  remove with:</span></span>
<span class="line"><span>  ssh-keygen -f &quot;/home/user/.ssh/known_hosts&quot; -R &quot;wupp.dev&quot;</span></span>
<span class="line"><span>Host key for wupp.dev has changed and you have requested strict checking.</span></span>
<span class="line"><span>Host key verification failed.</span></span></code></pre></div><p>¬øQu√© es lo que ocurre? Pues que la IP a la que nos estamos conectando es la misma pero las claves p√∫blicas del servidor, que son las que se utilizan para verificar su identidad, son distintas. Esto el ordenador lo confunde <em>(por precauci√≥n)</em> con un intento de suplantaci√≥n de la identidad del servidor, cosa que ser√≠a muy peligrosa en caso de ser cierta. Por eso no nos deja conectarnos.</p><p>Para que nos deje conectarnos es tan sencillo como eliminar el archivo de <code>known_hosts</code> mencionado en el error, pero entonces cada vez que reinici√°semos el servidor tendr√≠amos que estar eliminando ese archivo para poder conectarnos de nuevo y, si de verdad estuviesen intentando suplantar la identidad del servidor, no nos enterar√≠amos.</p><p>Por suerte, hay un apa√±o. Si ponemos Dropbear y OpenSSH Server en puertos distintos en el servidor, podemos utilizar una identidad distinta para cada puerto cuando nos conectemos.</p><h2 id="reforzando-la-seguridad" tabindex="-1">Reforzando la seguridad <a class="header-anchor" href="#reforzando-la-seguridad" aria-label="Permalink to ‚ÄúReforzando la seguridad‚Äù">‚Äã</a></h2><p>Todav√≠a tenemos que desactivar el acceso con usuario y contrase√±a por SSH, que es muy poco seguro, para restringir el acceso √∫nicamente a las claves p√∫blicas permitidas. Vamos a modificar la configuraci√≥n de OpenSSH pero, en lugar de modificar directamente <code>/etc/ssh/sshd_config</code>, vamos a crear un archivo nuevo en <code>/etc/ssh/sshd_config.d/</code> llamado <code>99-custom.conf</code>, que contendr√° las l√≠neas que queremos cambiar o a√±adir. De esta forma, si en el futuro actualizamos OpenSSH Server y se sobreescribe el archivo de configuraci√≥n principal, no perderemos los cambios que hemos hecho.</p><p>Dentro de <code>/etc/ssh/sshd_config.d/99-custom.conf</code> introducimos las siguientes l√≠neas:</p><div class="language-ssh-config"><button title="Copy Code" class="copy"></button><span class="lang">ssh-config</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Port</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 22</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PasswordAuthentication</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> no</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PermitRootLogin</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> no</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AllowUsers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> admin</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">X11Forwarding</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> no</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">KbdInteractiveAuthentication</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> no</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PubkeyAuthentication</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> yes</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AuthorizedKeysFile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> .ssh/authorized_keys</span></span></code></pre></div><p>Veamos qu√© significa cada l√≠nea:</p><ul><li><code>Port 22</code> indica el puerto en el que se ejecuta OpenSSH Server.</li><li><code>PasswordAuthentication no</code> proh√≠be los accesos con contrase√±a.</li><li><code>PermitRootLogin no</code> evita que se pueda acceder directamente al usuario <code>root</code>.</li><li><code>AllowUsers admin</code> es opcional pero recomendable, restringe los usuarios a los que se puede acceder directamente, se pueden poner varios separ√°ndolos por espacios.</li><li><code>X11Forwarding no</code> evita que se puedan ejecutar aplicaciones gr√°ficas de forma remota, pues es algo que en un principio no vamos a usar.</li><li><code>KbdInteractiveAuthentication no</code> deshabilita otro m√©todo de autenticaci√≥n que no vamos a usar.</li><li><code>PubkeyAuthentication yes</code> habilita la autenticaci√≥n por clave p√∫blica.</li><li><code>AuthorizedKeysFile .ssh/authorized_keys</code> indica la ruta del archivo donde se encuentran las claves p√∫blicas autorizadas.</li></ul><div class="warning custom-block"><p class="custom-block-title">ADVERTENCIA</p><p>Antes de hacer efectivos los cambios, tenemos que asegurarnos de que existe el archivo <code>/home/admin/.ssh/authorized_keys</code> y que tiene las claves p√∫blicas de los dispositivos desde los que nos queramos conectar al servidor, porque si no est√°n no podremos conectarnos.</p></div><p>Adem√°s, si hemos cambiado el puerto, debemos asegurarnos de que:</p><ul><li>El nuevo puerto est√° abierto en el router.</li><li>El nuevo puerto est√° permitido por el firewall. En el caso de UFW: <code>sudo ufw allow XXXX/tcp</code> donde <code>XXXX</code> es el nuevo puerto.</li></ul><div class="tip custom-block"><p class="custom-block-title">RELATO</p><p>Iv√°n mientras cambiaba el puerto de OpenSSH <em>(desde un sitio lejano a la ubicaci√≥n del servidor)</em> se olvid√≥ de permitir el nuevo puerto en el firewall y pasaron cosas malas, si quieres leer la historia completa puedes hacerlo <a href="./../relatos/bloqueo-ssh">aqu√≠</a>.</p></div><p>Por √∫ltimo, hacemos efectivos los cambios reiniciando el servicio:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ssh</span></span></code></pre></div><p>Y ya deber√≠amos de poder conectarnos sin que nos pida la contrase√±a del usuario <code>admin</code>.</p><p>Podemos verificar que se ha deshabilitado el acceso por contrase√±a intentando conectarnos con <code>ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no -p 2222 admin@wupp.dev</code>, que no nos debjar√°, o conect√°ndonos con <code>ssh -vvv -p 2222 admin@wupp.dev</code> y buscando en la salida la l√≠nea <code>Authentications that can continue: publickey</code>, que indica que solo se permite la autenticaci√≥n por clave p√∫blica.</p><h2 id="virtual-network-computing-vnc" tabindex="-1">Virtual Network Computing (VNC) <a class="header-anchor" href="#virtual-network-computing-vnc" aria-label="Permalink to ‚ÄúVirtual Network Computing (VNC)‚Äù">‚Äã</a></h2><p>¬øQu√© demonios es un VNC? Pues b√°sicamente un entorno gr√°fico de escritorio remoto. Se utiliza para controlar remotamente otros ordenadores con un escritorio como si fuese realmente tu propio ordenador. ¬øNo acabamos de desactivar eso en la configuraci√≥n del servidor SSH? Pues s√≠, pero vamos a usarlo de otra forma que es m√°s segura y no necesita esa opci√≥n activada.</p><p>Nosotros seguimos <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-vnc-on-debian-10" target="_blank" rel="noreferrer">este tutorial</a>. Aunque puede haber algunos m√°s actualizados como <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-vnc-on-debian-11" target="_blank" rel="noreferrer">este</a>.</p><p>Como detalles, no hemos establecido una contrase√±a para solo vista.</p><p>Aqu√≠ da igual cambiar o no el puerto por defecto, ya que no estar√° expuesto directamente a Internet.</p><div class="danger custom-block"><p class="custom-block-title">PELIGRO</p><p>Ni se te ocurra exponer el puerto del VNC directamente a Internet. No hay que abrirlo en el router ni permitirlo en el firewall. Siempre hay que conectarse al VNC a trav√©s de un t√∫nel SSH.</p></div><p>En nuestro ordenador podemos instalar <code>xtightvncviewer</code> para conectarnos. Solo tendremos que conectarnos mediante SSH al servidor indicando que queremos redirigir el puerto 5901 de nuestro ordenador al 5901 del del servidor. Esto lo podemos hacer con <code>ssh -L 5901:127.0.0.1:5901 admin@wupp.dev</code>. Una vez estemos conectados, podemos ejecutar <code>xtightvncviewer</code> desde la terminal, conectarnos a <code>localhost:5901</code> y poner la contrase√±a del VNC.</p><p>En nuestro caso, al intentar conectarnos nos encontramos con el siguiente error:</p><p><img src="/server/assets/fallo-vnc.Cfm-If9A.png" alt="Fallo VNC"></p><p>Por suerte, se solucion√≥ instalando un paquete y reiniciando el servidor VNC:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dbus-x11</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vncserver@1</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title custom-block-title-default">INFO</p><p>Es raro necesitar el servidor VNC, pero justo estoy escribiendo esta parte antes que la de configuraci√≥n de servidor SSH porque necesito abrir unos puertos en el router y para eso necesito acceder con un navegador desde el servidor, porque no estoy en la misma red. Como era de esperar, Debian no ven√≠a con navegador instalado, as√≠ que para poder usar uno con el VNC instal√© Firefox con <code>sudo apt install firefox-esr</code>.</p></div><h2 id="embelleciendo" tabindex="-1">Embelleciendo <a class="header-anchor" href="#embelleciendo" aria-label="Permalink to ‚ÄúEmbelleciendo‚Äù">‚Äã</a></h2><p>Cuando iniciamos sesi√≥n por SSH nos aparece un mensaje como este:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Linux server 5.10.0-21-amd64 #1 SMP Debian 5.10.162-1 (2023-01-21) x86_64</span></span>
<span class="line"><span></span></span>
<span class="line"><span>The programs included with the Debian GNU/Linux system are free software;</span></span>
<span class="line"><span>the exact distribution terms for each program are described in the</span></span>
<span class="line"><span>individual files in /usr/share/doc/*/copyright.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span></span>
<span class="line"><span>permitted by applicable law.</span></span>
<span class="line"><span>Last login: Mon May 24 01:23:45 2032 from 192.168.1.1</span></span></code></pre></div><p>Que no es muy bonito la verdad, as√≠ que podemos hacer unos cambios para que quede un mensaje mucho m√°s lindo.</p><ol><li>Editamos <code>/etc/ssh/sshd_config.d/99-custom.conf</code> para a√±adir las siguientes l√≠neas:</li></ol><div class="language-ssh-config"><button title="Copy Code" class="copy"></button><span class="lang">ssh-config</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PrintMotd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> no</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PrintLastLog</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> no</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Banner</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> none</span></span></code></pre></div><ol start="2"><li>Quitamos el resto del mensaje de bienvenida con <code>sudo truncate -s 0 /etc/motd</code>.</li><li>Editamos <code>/etc/pam.d/sshd</code> para asegurarnos de que las siguientes l√≠neas est√°n comentadas:</li></ol><div class="language-ssh-config"><button title="Copy Code" class="copy"></button><span class="lang">ssh-config</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Print the message of the day upon successful login.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># This includes a dynamically generated part from /run/motd.dynamic</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># and a static (admin-editable) part from /etc/motd.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#session    optional     pam_motd.so  motd=/run/motd.dynamic</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#session    optional     pam_motd.so noupdate</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Print the status of the user&#39;s mailbox upon successful login.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#session    optional     pam_mail.so standard noenv # [1]</span></span></code></pre></div><ol start="4"><li>Instalamos <code>figlet</code>, <code>lolcat</code> y <code>wtmpdb</code> para tener colores, cabeceras personalizadas y la informaci√≥n de la √∫ltima conexi√≥n <code>sudo apt update &amp;&amp; sudo apt install figlet lolcat wtmpdb</code>.</li><li>Creamos el archivo <code>~/welcome_message.sh</code>:</li></ol><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Cabecera personalizada</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;WUPP . DEV&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> figlet</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lolcat</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># √öltima conexi√≥n</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">last_login</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">last</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -F</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $USER </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> head</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tail</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">login_time</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $last_login </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{print $5 &quot; &quot; $6 &quot; &quot; $7 &quot; &quot; $8}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\e[1;33m√öltima conexi√≥n:\e[0m&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $login_time</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Informaci√≥n del uso del sistema</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\e[1;33mUso del CPU:\e[0m&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;cpu &#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /proc/stat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{usage=($2+$4)*100/($2+$4+$5)} END {print usage &quot;%&quot;}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\e[1;33mUso de memoria:\e[0m&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">free</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;NR==2{printf &quot;%.2f%%\t\t&quot;, $3*100/$2 }&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Espacio en disco</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\e[1;33mEspacio en disco:\e[0m&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">df</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -h</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -vE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;^tmpfs|udev&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{print $1 &quot;\t&quot; $5 &quot;\t&quot; $6}&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lolcat</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span></span></code></pre></div><ol start="6"><li>Hacemos el archivo ejecutable <code>sudo chmod +x ~/welcome_message.sh</code> y lo a√±adimos a <code>~/.bashrc</code>:</li></ol><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ~/.bashrc: executed by bash(1) for non-login shells.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># see /usr/share/doc/bash/examples/startup-files (in the package bash-doc)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># for examples</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Add the welcome message</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/welcome_message.sh</span></span></code></pre></div><ol start="7"><li>Reiniciamos el servicio de SSH <code>sudo systemctl restart ssh</code>, nos desconectamos y nos volvemos a conectar para comprobar que funciona.</li></ol></div></div></main><footer class="VPDocFooter" data-v-6fb275ed data-v-0b58e045><!--[--><!--]--><div class="edit-info" data-v-0b58e045><!----><div class="last-updated" data-v-0b58e045><p class="VPLastUpdated" data-v-0b58e045 data-v-0e233eb8>Actualizado por √∫ltima vez: <time datetime="2026-01-22T00:33:11.000Z" data-v-0e233eb8></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-0b58e045><span class="visually-hidden" id="doc-footer-aria-label" data-v-0b58e045>Pager</span><div class="pager" data-v-0b58e045><a class="VPLink link pager-link prev" href="/server/equipo/router-dominio" data-v-0b58e045><!--[--><span class="desc" data-v-0b58e045>P√°gina anterior</span><span class="title" data-v-0b58e045>Router y dominio</span><!--]--></a></div><div class="pager" data-v-0b58e045><a class="VPLink link pager-link next" href="/server/equipo/nginx" data-v-0b58e045><!--[--><span class="desc" data-v-0b58e045>P√°gina siguiente</span><span class="title" data-v-0b58e045>Servidor web</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-0df3b126 data-v-13bee918><div class="container" data-v-13bee918><p class="message" data-v-13bee918>Distribuido bajo la licencia CC BY.</p><p class="copyright" data-v-13bee918>Copyright ¬© 2022-presente Lucas de U√±a Ocampo e Iv√°n Salido Cobo</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"equipo_conectando-servidores.md\":\"e6mi0OfL\",\"equipo_copias-seguridad.md\":\"DzceBFFR\",\"equipo_docker.md\":\"DABdRKd_\",\"equipo_gestion-remota.md\":\"BVEQ1oui\",\"equipo_hardware.md\":\"CQOmlM-O\",\"equipo_historia.md\":\"DH3sXH4r\",\"equipo_index.md\":\"CL0XUfWv\",\"equipo_mariadb-docker.md\":\"B14z3Eda\",\"equipo_monitorizacion.md\":\"tDzNCahZ\",\"equipo_nginx.md\":\"3UDjD23m\",\"equipo_router-dominio.md\":\"zpLmRavp\",\"equipo_sistema-encriptado.md\":\"BtMX1CXF\",\"index.md\":\"-rcpLcrN\",\"nosotros.md\":\"DBT8IJ78\",\"relatos_bloqueo-ssh.md\":\"BSfBDXK7\",\"relatos_dns-initramfs.md\":\"B2JBoXHr\",\"relatos_docker.md\":\"CevIpoRQ\",\"relatos_index.md\":\"pibKAzNh\",\"relatos_moviendo-var.md\":\"BAnFlzOJ\",\"relatos_tunel-ssh-ulp.md\":\"YgvZMpUd\",\"servicios_index.md\":\"Bp0pzqYY\",\"servicios_mailserver.md\":\"DHQkyvbc\",\"servicios_minecraft.md\":\"C4W6SVE3\",\"servicios_minio.md\":\"BwB_77OO\",\"servicios_navidrome.md\":\"BFiWKWSU\",\"servicios_nextcloud.md\":\"iBEbz351\",\"shared_servicios_puertos.md\":\"PIRGl2yP\",\"shared_servicios_recordatorios-nginx.md\":\"DcakjFdo\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"es-ES\",\"dir\":\"ltr\",\"title\":\"WUPP\",\"description\":\"Gu√≠a del servidor.\",\"base\":\"/server/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/favicon.svg\",\"outlineTitle\":\"En esta p√°gina\",\"nav\":[{\"text\":\"Inicio\",\"link\":\"/\",\"activeMatch\":\"\"},{\"text\":\"Nosotros\",\"link\":\"/nosotros\",\"activeMatch\":\"^/nosotros$\"},{\"text\":\"Gu√≠a del servidor\",\"link\":\"/equipo/historia\",\"activeMatch\":\"^/(?!$|nosotros$)\"},{\"text\":\"Archivos de configuraci√≥n\",\"link\":\"https://github.com/wupp-dev/server/tree/main/fs\",\"target\":\"_blank\"}],\"sidebar\":[{\"text\":\"Equipo\",\"items\":[{\"text\":\"Historia\",\"link\":\"/equipo/historia\"},{\"text\":\"Hardware\",\"link\":\"/equipo/hardware\"},{\"text\":\"Instalaci√≥n del SO encriptado\",\"link\":\"/equipo/sistema-encriptado\"},{\"text\":\"Router y dominio\",\"link\":\"/equipo/router-dominio\"},{\"text\":\"Gesti√≥n remota\",\"link\":\"/equipo/gestion-remota\"},{\"text\":\"Servidor web\",\"link\":\"/equipo/nginx\"},{\"text\":\"Docker\",\"link\":\"/equipo/docker\"},{\"text\":\"Base de datos\",\"link\":\"/equipo/mariadb-docker\"},{\"text\":\"Monitorizaci√≥n\",\"link\":\"/equipo/monitorizacion\"},{\"text\":\"Conectando servidores\",\"link\":\"/equipo/conectando-servidores\"},{\"text\":\"Copias de seguridad\",\"link\":\"/equipo/copias-seguridad\"}]},{\"text\":\"Servicios\",\"items\":[{\"text\":\"Nextcloud - Almacenamiento\",\"link\":\"/servicios/nextcloud\"},{\"text\":\"Docker Mailserver - Correo electr√≥nico\",\"link\":\"/servicios/mailserver\"},{\"text\":\"MinIO - Almacenamiento S3\",\"link\":\"/servicios/minio\"},{\"text\":\"Minecraft con AMP\",\"link\":\"/servicios/minecraft\"},{\"text\":\"Navidrome - Streaming de m√∫sica\",\"link\":\"/servicios/navidrome\"}]},{\"text\":\"Relatos\",\"items\":[{\"text\":\"Bloqueo de SSH\",\"link\":\"/relatos/bloqueo-ssh\"},{\"text\":\"Docker y sus cosas\",\"link\":\"/relatos/docker\"},{\"text\":\"Resoluci√≥n de dominios en initramfs\",\"link\":\"/relatos/dns-initramfs\"},{\"text\":\"T√∫nel SSH en la UGR LAN Party de 2024\",\"link\":\"/relatos/tunel-ssh-ulp\"},{\"text\":\"Moviendo /var a otro disco\",\"link\":\"/relatos/moviendo-var\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/wupp-dev/server/\",\"ariaLabel\":\"Repositorio GitHub de este proyecto\"}],\"footer\":{\"message\":\"Distribuido bajo la licencia CC BY.\",\"copyright\":\"Copyright ¬© 2022-presente Lucas de U√±a Ocampo e Iv√°n Salido Cobo\"},\"notFound\":{\"title\":\"P√°gina no encontrada\",\"quote\":\"Caminante, no hay camino, se hace camino al andar.\",\"linkLabel\":\"Volver al inicio\",\"linkText\":\"Volver al inicio\"},\"lastUpdated\":{\"text\":\"Actualizado por √∫ltima vez\"},\"docFooter\":{\"prev\":\"P√°gina anterior\",\"next\":\"P√°gina siguiente\"},\"darkModeSwitchLabel\":\"Apariencia\",\"lightModeSwitchTitle\":\"Cambiar a modo claro\",\"darkModeSwitchTitle\":\"Cambiar a modo oscuro\",\"sidebarMenuLabel\":\"Men√∫\",\"returnToTopLabel\":\"Volver arriba\",\"skipToContentLabel\":\"Saltar al contenido\",\"externalLinkIcon\":true,\"search\":{\"provider\":\"local\",\"options\":{\"translations\":{\"button\":{\"buttonText\":\"Buscar\",\"buttonAriaLabel\":\"Buscar\"},\"modal\":{\"displayDetails\":\"Mostrar detalles\",\"resetButtonTitle\":\"Restablecer\",\"backButtonTitle\":\"Volver\",\"noResultsText\":\"No se han encontrado resultados\",\"footer\":{\"selectText\":\"Seleccionar\",\"selectKeyAriaLabel\":\"Tecla Enter\",\"navigateText\":\"Navegar\",\"navigateUpKeyAriaLabel\":\"Tecla flecha arriba\",\"navigateDownKeyAriaLabel\":\"Tecla flecha abajo\",\"closeText\":\"Cerrar\",\"closeKeyAriaLabel\":\"Tecla Escape\"}}}}}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true,\"additionalConfig\":{}}");</script>
    
  </body>
</html>