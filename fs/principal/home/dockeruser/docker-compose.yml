version: "3.9"

services:
  nextcloud-db:
    image: postgres
    restart: unless-stopped
    volumes:
      - /var/lib/nextcloud/postgresql/data:/var/lib/postgresql:Z
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=psswd
      - POSTGRES_DB=nextcloud

  nextcloud-redis:
    image: redis
    container_name: nextcloud-redis
    command: redis-server

  nextcloud:
    image: nextcloud:fpm
    container_name: nextcloud
    restart: unless-stopped
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    environment:
      - POSTGRES_HOST=nextcloud-db
      - NEXTCLOUD_TRUSTED_DOMAINS=cloud.wupp.dev
      - REDIS_HOST=nextcloud-redis
      - REDIS_HOST_PORT=6379
      - PHP_MEMORY_LIMIT=50G
      - PHP_UPLOAD_LIMIT=50G
    ports:
      - 26848:9000
    volumes:
      - /var/www/nextcloud:/var/www/html
      - /var/www/nextcloud/manual-php.ini:/usr/local/etc/php/conf.d/manual-php.ini

  nextcloud-cron:
    image: nextcloud:fpm
    container_name: nextcloud-cron
    restart: unless-stopped
    depends_on:
      - db
      - nextcloud-redis
    volumes:
      - /var/www/nextcloud:/var/www/html
    entrypoint: /cron.sh

  nextcloud-imaginary:
    image: nextcloud/aio-imaginary:latest
    restart: unless-stopped
    ports:
      - 22394:9000
    command: -concurrency 20 -enable-url-source -return-size
    cap_add:
      - SYS_NICE

  mailserver:
    image: mailserver/docker-mailserver
    container_name: mailserver
    restart: unless-stopped
    env_file: mailserver.env
    ports:
      - "25:25" # SMTP  (explicit TLS => STARTTLS)
      - "143:143" # IMAP4 (explicit TLS => STARTTLS)
      - "465:465" # ESMTP (implicit TLS)
      - "587:587" # ESMTP (explicit TLS => STARTTLS)
      - "993:993" # IMAP4 (implicit TLS)
      - "11334:11334" # RSPAMD web
    volumes:
      - /var/dms/mail-data/:/var/mail/
      - /var/dms/mail-state/:/var/mail-state/
      - /var/dms/mail-logs/:/var/log/mail/
      - /var/dms/config/:/tmp/docker-mailserver/
      - /etc/localtime:/etc/localtime:ro
      - /etc/letsencrypt:/etc/letsencrypt
      - /etc/rspamd/local.d/worker-controller.inc:/etc/rspamd/local.d/worker-controller.inc
    hostname: mail.wupp.dev
    stop_grace_period: 1m
    cap_add:
      - NET_ADMIN
    healthcheck:
      test: "ss --listening --tcp | grep -P 'LISTEN.+:smtp' || exit 1"
      timeout: 3s
      retries: 0
